name: Test Auto-Whitelist Complex

# This workflow tests the auto-whitelist feature by simulating multiple iterations
# across sequential jobs. Each job represents one "iteration" of the auto-whitelist
# process, simulating what would happen across multiple workflow runs.
#
# Note: The action uses `gh run download` to fetch artifacts from previous workflow
# runs. For testing within a single workflow run, we manually download artifacts
# from previous jobs before the action runs, placing them in ~/ so the action
# can detect them when it checks for existing whitelist files.

on:
  workflow_dispatch:
  push:
    branches:
      - 'dev'
      - 'main'

# Auto cancel previous runs if they were not completed.
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref_name }}
  cancel-in-progress: true

# Declare default permissions as read only.
permissions: read-all

jobs:
  # Iteration 1: Initial whitelist creation (listen-only mode)
  auto-whitelist-iteration-1:
    timeout-minutes: 30
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup EDAMAME Posture - Iteration 1
        id: iteration-1
        uses: ./
        with:
          disconnected_mode: true
          network_scan: true
          packet_capture: true
          auto_whitelist: true
          auto_whitelist_artifact_name: test-complex-auto-whitelist-${{ runner.os }}
          auto_whitelist_stability_threshold: "0"
          auto_whitelist_stability_consecutive_runs: "3"
          auto_whitelist_max_iterations: "10"
          dump_sessions_log: true
          display_logs: false
        continue-on-error: true

      - name: Simulate Network Traffic - Iteration 1
        if: steps.iteration-1.outcome == 'success'
        run: |
          echo "Simulating iteration 1 network traffic patterns..."
          # Simulate basic network connections that should be whitelisted
          curl -s --max-time 5 https://www.github.com > /dev/null || true
          curl -s --max-time 5 https://registry.npmjs.org > /dev/null || true
          curl -s --max-time 5 https://api.github.com > /dev/null || true
          sleep 2

      - name: Dump Whitelist - Iteration 1
        if: steps.iteration-1.outcome == 'success'
        run: |
          echo "=== Iteration 1 Whitelist Contents ==="
          if [[ -f ~/auto_whitelist.json ]]; then
            echo "Whitelist file exists"
            echo "File size: $(wc -c < ~/auto_whitelist.json) bytes"
            echo "Number of endpoints: $(jq '[.whitelists[].endpoints | length] | add' ~/auto_whitelist.json 2>/dev/null || echo 'N/A')"
            echo ""
            echo "Whitelist JSON (first 2000 chars):"
            head -c 2000 ~/auto_whitelist.json || cat ~/auto_whitelist.json
            echo ""
            echo "..."
          else
            echo "⚠️  Whitelist file not found!"
          fi

      - name: Verify Iteration 1 Status
        if: steps.iteration-1.outcome == 'success'
        run: |
          echo "=== Iteration 1 Verification ==="
          echo "Expected: Initial whitelist created (listen-only mode)"
          echo "Status should be: created"
          echo "Stable should be: false"

  # Iteration 2: First augmentation (should add new endpoints)
  auto-whitelist-iteration-2:
    timeout-minutes: 30
    needs: auto-whitelist-iteration-1
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download artifact from previous iteration
        uses: actions/download-artifact@v4
        with:
          name: test-complex-auto-whitelist-${{ runner.os }}
          path: ~/
          github-token: ${{ github.token }}
        continue-on-error: true

      - name: Verify artifact download
        run: |
          if [[ -f ~/auto_whitelist.json ]]; then
            echo "✅ Artifact downloaded successfully"
            echo "Iteration: $(cat ~/auto_whitelist_iteration.txt 2>/dev/null || echo 'unknown')"
            echo "Stable count: $(cat ~/auto_whitelist_stable_count.txt 2>/dev/null || echo '0')"
          else
            echo "⚠️  No artifact found (this might be expected for iteration 2)"
          fi

      - name: Setup EDAMAME Posture - Iteration 2
        id: iteration-2
        uses: ./
        with:
          disconnected_mode: true
          network_scan: true
          packet_capture: true
          auto_whitelist: true
          auto_whitelist_artifact_name: test-complex-auto-whitelist-${{ runner.os }}
          auto_whitelist_stability_threshold: "0"
          auto_whitelist_stability_consecutive_runs: "3"
          auto_whitelist_max_iterations: "10"
          dump_sessions_log: true
          display_logs: false
        continue-on-error: true

      - name: Simulate Network Traffic - Iteration 2
        if: steps.iteration-2.outcome == 'success'
        run: |
          echo "Simulating iteration 2 network traffic patterns..."
          # Same connections as iteration 1 (should be stable)
          curl -s --max-time 5 https://www.github.com > /dev/null || true
          curl -s --max-time 5 https://registry.npmjs.org > /dev/null || true
          curl -s --max-time 5 https://api.github.com > /dev/null || true
          # Add NEW connections (should cause augmentation)
          curl -s --max-time 5 https://www.npmjs.com > /dev/null || true
          curl -s --max-time 5 https://cdn.jsdelivr.net > /dev/null || true
          sleep 2

      - name: Dump Whitelist - Iteration 2
        if: steps.iteration-2.outcome == 'success'
        run: |
          echo "=== Iteration 2 Whitelist Contents ==="
          if [[ -f ~/auto_whitelist.json ]]; then
            echo "Whitelist file exists"
            echo "File size: $(wc -c < ~/auto_whitelist.json) bytes"
            echo "Number of endpoints: $(jq '[.whitelists[].endpoints | length] | add' ~/auto_whitelist.json 2>/dev/null || echo 'N/A')"
            echo ""
            echo "Whitelist JSON (first 2000 chars):"
            head -c 2000 ~/auto_whitelist.json || cat ~/auto_whitelist.json
            echo ""
            echo "..."
          else
            echo "⚠️  Whitelist file not found!"
          fi

      - name: Compare Whitelists - Iteration 2
        if: steps.iteration-2.outcome == 'success'
        run: |
          echo "=== Iteration 2 Comparison ==="
          if [[ -f ~/auto_whitelist.json ]] && [[ -f ~/auto_whitelist_old.json ]]; then
            echo "Comparing old vs new whitelist..."
            # The action should have done this, but let's verify
            if command -v edamame_posture &> /dev/null; then
              DIFF=$(edamame_posture compare-custom-whitelists-from-files ~/auto_whitelist_old.json ~/auto_whitelist.json 2>/dev/null || echo "N/A")
              echo "Difference percentage: $DIFF"
            else
              echo "edamame_posture not available for comparison"
            fi
          else
            echo "⚠️  Cannot compare - missing whitelist files"
            ls -la ~/auto_whitelist*.json 2>/dev/null || echo "No whitelist files found"
          fi

      - name: Verify Iteration 2 Status
        if: steps.iteration-2.outcome == 'success'
        run: |
          echo "=== Iteration 2 Verification ==="
          echo "Expected: Whitelist augmented with new endpoints"
          echo "Status should be: evolving"
          echo "Difference should be: > 0%"
          echo "Stable count should reset to: 0"

  # Iteration 3: More augmentation (different endpoints)
  auto-whitelist-iteration-3:
    timeout-minutes: 30
    needs: auto-whitelist-iteration-2
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download artifact from previous iteration
        uses: actions/download-artifact@v4
        with:
          name: test-complex-auto-whitelist-${{ runner.os }}
          path: ~/
          github-token: ${{ github.token }}

      - name: Setup EDAMAME Posture - Iteration 3
        id: iteration-3
        uses: ./
        with:
          disconnected_mode: true
          network_scan: true
          packet_capture: true
          auto_whitelist: true
          auto_whitelist_artifact_name: test-complex-auto-whitelist-${{ runner.os }}
          auto_whitelist_stability_threshold: "0"
          auto_whitelist_stability_consecutive_runs: "3"
          auto_whitelist_max_iterations: "10"
          dump_sessions_log: true
          display_logs: false
        continue-on-error: true

      - name: Simulate Network Traffic - Iteration 3
        if: steps.iteration-3.outcome == 'success'
        run: |
          echo "Simulating iteration 3 network traffic patterns..."
          # All previous connections
          curl -s --max-time 5 https://www.github.com > /dev/null || true
          curl -s --max-time 5 https://registry.npmjs.org > /dev/null || true
          curl -s --max-time 5 https://api.github.com > /dev/null || true
          curl -s --max-time 5 https://www.npmjs.com > /dev/null || true
          curl -s --max-time 5 https://cdn.jsdelivr.net > /dev/null || true
          # Add MORE new connections
          curl -s --max-time 5 https://fonts.googleapis.com > /dev/null || true
          curl -s --max-time 5 https://www.google-analytics.com > /dev/null || true
          sleep 2

      - name: Dump Whitelist - Iteration 3
        if: steps.iteration-3.outcome == 'success'
        run: |
          echo "=== Iteration 3 Whitelist Contents ==="
          if [[ -f ~/auto_whitelist.json ]]; then
            echo "Whitelist file exists"
            echo "File size: $(wc -c < ~/auto_whitelist.json) bytes"
            echo "Number of endpoints: $(jq '[.whitelists[].endpoints | length] | add' ~/auto_whitelist.json 2>/dev/null || echo 'N/A')"
            echo ""
            echo "Sample endpoints (first 10):"
            jq -r '.whitelists[0].endpoints[0:10] | .[] | "\(.domain // "N/A") | \(.ip // "N/A") | \(.port // "N/A")"' ~/auto_whitelist.json 2>/dev/null || echo "Could not parse JSON"
          else
            echo "⚠️  Whitelist file not found!"
          fi

      - name: Verify Iteration 3 Status
        if: steps.iteration-3.outcome == 'success'
        run: |
          echo "=== Iteration 3 Verification ==="
          echo "Expected: Whitelist further augmented"
          echo "Status should be: evolving"
          echo "Difference should be: > 0%"
          echo "Stable count should reset to: 0"

  # Iteration 4: Stable run (no new endpoints)
  auto-whitelist-iteration-4:
    timeout-minutes: 30
    needs: auto-whitelist-iteration-3
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download artifact from previous iteration
        uses: actions/download-artifact@v4
        with:
          name: test-complex-auto-whitelist-${{ runner.os }}
          path: ~/
          github-token: ${{ github.token }}

      - name: Setup EDAMAME Posture - Iteration 4
        id: iteration-4
        uses: ./
        with:
          disconnected_mode: true
          network_scan: true
          packet_capture: true
          auto_whitelist: true
          auto_whitelist_artifact_name: test-complex-auto-whitelist-${{ runner.os }}
          auto_whitelist_stability_threshold: "0"
          auto_whitelist_stability_consecutive_runs: "3"
          auto_whitelist_max_iterations: "10"
          dump_sessions_log: true
          display_logs: false
        continue-on-error: true

      - name: Simulate Network Traffic - Iteration 4 (Stable)
        if: steps.iteration-4.outcome == 'success'
        run: |
          echo "Simulating iteration 4 network traffic patterns (STABLE - no new endpoints)..."
          # Only use connections that were already whitelisted
          curl -s --max-time 5 https://www.github.com > /dev/null || true
          curl -s --max-time 5 https://registry.npmjs.org > /dev/null || true
          curl -s --max-time 5 https://api.github.com > /dev/null || true
          curl -s --max-time 5 https://www.npmjs.com > /dev/null || true
          curl -s --max-time 5 https://cdn.jsdelivr.net > /dev/null || true
          curl -s --max-time 5 https://fonts.googleapis.com > /dev/null || true
          curl -s --max-time 5 https://www.google-analytics.com > /dev/null || true
          sleep 2

      - name: Dump Whitelist - Iteration 4
        if: steps.iteration-4.outcome == 'success'
        run: |
          echo "=== Iteration 4 Whitelist Contents ==="
          if [[ -f ~/auto_whitelist.json ]]; then
            echo "Whitelist file exists"
            echo "File size: $(wc -c < ~/auto_whitelist.json) bytes"
            echo "Number of endpoints: $(jq '[.whitelists[].endpoints | length] | add' ~/auto_whitelist.json 2>/dev/null || echo 'N/A')"
            echo ""
            echo "All domains in whitelist:"
            jq -r '.whitelists[].endpoints[] | select(.domain != null) | .domain' ~/auto_whitelist.json 2>/dev/null | sort -u | head -20 || echo "Could not extract domains"
          else
            echo "⚠️  Whitelist file not found!"
          fi

      - name: Verify Iteration 4 Status
        if: steps.iteration-4.outcome == 'success'
        run: |
          echo "=== Iteration 4 Verification ==="
          echo "Expected: First stable run (0% difference)"
          echo "Status should be: stable"
          echo "Difference should be: 0%"
          echo "Stable count should be: 1 / 3"

  # Iteration 5: Second stable run
  auto-whitelist-iteration-5:
    timeout-minutes: 30
    needs: auto-whitelist-iteration-4
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download artifact from previous iteration
        uses: actions/download-artifact@v4
        with:
          name: test-complex-auto-whitelist-${{ runner.os }}
          path: ~/
          github-token: ${{ github.token }}

      - name: Setup EDAMAME Posture - Iteration 5
        id: iteration-5
        uses: ./
        with:
          disconnected_mode: true
          network_scan: true
          packet_capture: true
          auto_whitelist: true
          auto_whitelist_artifact_name: test-complex-auto-whitelist-${{ runner.os }}
          auto_whitelist_stability_threshold: "0"
          auto_whitelist_stability_consecutive_runs: "3"
          auto_whitelist_max_iterations: "10"
          dump_sessions_log: true
          display_logs: false
        continue-on-error: true

      - name: Simulate Network Traffic - Iteration 5 (Stable)
        if: steps.iteration-5.outcome == 'success'
        run: |
          echo "Simulating iteration 5 network traffic patterns (STABLE - no new endpoints)..."
          # Same connections as iteration 4
          curl -s --max-time 5 https://www.github.com > /dev/null || true
          curl -s --max-time 5 https://registry.npmjs.org > /dev/null || true
          curl -s --max-time 5 https://api.github.com > /dev/null || true
          curl -s --max-time 5 https://www.npmjs.com > /dev/null || true
          curl -s --max-time 5 https://cdn.jsdelivr.net > /dev/null || true
          curl -s --max-time 5 https://fonts.googleapis.com > /dev/null || true
          curl -s --max-time 5 https://www.google-analytics.com > /dev/null || true
          sleep 2

      - name: Verify Iteration 5 Status
        if: steps.iteration-5.outcome == 'success'
        run: |
          echo "=== Iteration 5 Verification ==="
          echo "Expected: Second stable run (0% difference)"
          echo "Status should be: stable"
          echo "Difference should be: 0%"
          echo "Stable count should be: 2 / 3"

  # Iteration 6: Third stable run (should trigger enforcement)
  auto-whitelist-iteration-6:
    timeout-minutes: 30
    needs: auto-whitelist-iteration-5
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download artifact from previous iteration
        uses: actions/download-artifact@v4
        with:
          name: test-complex-auto-whitelist-${{ runner.os }}
          path: ~/
          github-token: ${{ github.token }}

      - name: Setup EDAMAME Posture - Iteration 6
        id: iteration-6
        uses: ./
        with:
          disconnected_mode: true
          network_scan: true
          packet_capture: true
          auto_whitelist: true
          auto_whitelist_artifact_name: test-complex-auto-whitelist-${{ runner.os }}
          auto_whitelist_stability_threshold: "0"
          auto_whitelist_stability_consecutive_runs: "3"
          auto_whitelist_max_iterations: "10"
          dump_sessions_log: true
          display_logs: false
        continue-on-error: true

      - name: Simulate Network Traffic - Iteration 6 (Stable)
        if: steps.iteration-6.outcome == 'success'
        run: |
          echo "Simulating iteration 6 network traffic patterns (STABLE - no new endpoints)..."
          # Same connections as previous stable runs
          curl -s --max-time 5 https://www.github.com > /dev/null || true
          curl -s --max-time 5 https://registry.npmjs.org > /dev/null || true
          curl -s --max-time 5 https://api.github.com > /dev/null || true
          curl -s --max-time 5 https://www.npmjs.com > /dev/null || true
          curl -s --max-time 5 https://cdn.jsdelivr.net > /dev/null || true
          curl -s --max-time 5 https://fonts.googleapis.com > /dev/null || true
          curl -s --max-time 5 https://www.google-analytics.com > /dev/null || true
          sleep 2

      - name: Dump Whitelist - Iteration 6
        if: steps.iteration-6.outcome == 'success'
        run: |
          echo "=== Iteration 6 Whitelist Contents (FINAL STABLE) ==="
          if [[ -f ~/auto_whitelist.json ]]; then
            echo "Whitelist file exists"
            echo "File size: $(wc -c < ~/auto_whitelist.json) bytes"
            echo "Number of endpoints: $(jq '[.whitelists[].endpoints | length] | add' ~/auto_whitelist.json 2>/dev/null || echo 'N/A')"
            echo ""
            echo "=== ALL WHITELISTED DOMAINS ==="
            jq -r '.whitelists[].endpoints[] | select(.domain != null) | .domain' ~/auto_whitelist.json 2>/dev/null | sort -u || echo "Could not extract domains"
            echo ""
            echo "=== ALL WHITELISTED IPs ==="
            jq -r '.whitelists[].endpoints[] | select(.ip != null) | .ip' ~/auto_whitelist.json 2>/dev/null | sort -u | head -20 || echo "Could not extract IPs"
            echo ""
            echo "=== FULL WHITELIST JSON ==="
            cat ~/auto_whitelist.json
          else
            echo "⚠️  Whitelist file not found!"
          fi

      - name: Verify Iteration 6 Status
        if: steps.iteration-6.outcome == 'success'
        run: |
          echo "=== Iteration 6 Verification ==="
          echo "Expected: Third stable run - WHITELIST SHOULD BE FULLY STABLE"
          echo "Status should be: stable"
          echo "Difference should be: 0%"
          echo "Stable count should be: 3 / 3"
          echo "Enforcement mode should be: ACTIVE"

  # Iteration 7: Enforcement mode test (should allow whitelisted traffic)
  auto-whitelist-iteration-7-enforcement-pass:
    timeout-minutes: 30
    needs: auto-whitelist-iteration-6
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download artifact from previous iteration
        uses: actions/download-artifact@v4
        with:
          name: test-complex-auto-whitelist-${{ runner.os }}
          path: ~/
          github-token: ${{ github.token }}

      - name: Setup EDAMAME Posture - Iteration 7 (Enforcement Pass)
        id: iteration-7-pass
        uses: ./
        with:
          disconnected_mode: true
          network_scan: true
          packet_capture: true
          auto_whitelist: true
          auto_whitelist_artifact_name: test-complex-auto-whitelist-${{ runner.os }}
          auto_whitelist_stability_threshold: "0"
          auto_whitelist_stability_consecutive_runs: "3"
          auto_whitelist_max_iterations: "10"
          dump_sessions_log: true
          exit_on_whitelist_exceptions: true
          display_logs: false
        continue-on-error: true

      - name: Simulate Network Traffic - Iteration 7 (Only Whitelisted)
        if: steps.iteration-7-pass.outcome == 'success'
        run: |
          echo "Simulating iteration 7 network traffic patterns (ENFORCEMENT MODE - only whitelisted endpoints)..."
          # Only use endpoints that are already in the whitelist
          curl -s --max-time 5 https://www.github.com > /dev/null || true
          curl -s --max-time 5 https://registry.npmjs.org > /dev/null || true
          curl -s --max-time 5 https://api.github.com > /dev/null || true
          curl -s --max-time 5 https://www.npmjs.com > /dev/null || true
          curl -s --max-time 5 https://cdn.jsdelivr.net > /dev/null || true
          curl -s --max-time 5 https://fonts.googleapis.com > /dev/null || true
          curl -s --max-time 5 https://www.google-analytics.com > /dev/null || true
          sleep 2

      - name: Dump Sessions - Iteration 7
        if: steps.iteration-7-pass.outcome == 'success'
        run: |
          echo "=== Iteration 7 Session Logs ==="
          if command -v edamame_posture &> /dev/null; then
            echo "Getting sessions..."
            edamame_posture get-sessions || echo "get-sessions failed or returned non-zero"
          else
            echo "edamame_posture not available"
          fi

      - name: Verify Iteration 7 Pass Status
        if: steps.iteration-7-pass.outcome == 'success'
        run: |
          echo "=== Iteration 7 Verification (Enforcement Pass) ==="
          echo "Expected: All traffic conforms to whitelist"
          echo "Exit code should be: 0 (success)"
          echo "No whitelist exceptions should be detected"
          echo ""
          echo "Actual outcome: ${{ steps.iteration-7-pass.outcome }}"

  # Iteration 8: Enforcement mode test (should fail on unauthorized traffic)
  auto-whitelist-iteration-8-enforcement-fail:
    timeout-minutes: 30
    needs: auto-whitelist-iteration-7-enforcement-pass
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download artifact from previous iteration
        uses: actions/download-artifact@v4
        with:
          name: test-complex-auto-whitelist-${{ runner.os }}
          path: ~/
          github-token: ${{ github.token }}

      - name: Setup EDAMAME Posture - Iteration 8 (Enforcement Fail)
        id: iteration-8-fail
        uses: ./
        with:
          disconnected_mode: true
          network_scan: true
          packet_capture: true
          auto_whitelist: true
          auto_whitelist_artifact_name: test-complex-auto-whitelist-${{ runner.os }}
          auto_whitelist_stability_threshold: "0"
          auto_whitelist_stability_consecutive_runs: "3"
          auto_whitelist_max_iterations: "10"
          dump_sessions_log: true
          exit_on_whitelist_exceptions: true
          display_logs: false
        continue-on-error: true

      - name: Dump Whitelist - Iteration 8 (Before Traffic)
        run: |
          echo "=== Iteration 8 Whitelist Contents (BEFORE TRAFFIC) ==="
          if [[ -f ~/auto_whitelist.json ]]; then
            echo "Whitelist file exists"
            echo "File size: $(wc -c < ~/auto_whitelist.json) bytes"
            echo "Number of endpoints: $(jq '[.whitelists[].endpoints | length] | add' ~/auto_whitelist.json 2>/dev/null || echo 'N/A')"
            echo ""
            echo "=== ALL WHITELISTED DOMAINS ==="
            jq -r '.whitelists[].endpoints[] | select(.domain != null) | .domain' ~/auto_whitelist.json 2>/dev/null | sort -u || echo "Could not extract domains"
            echo ""
            echo "Checking if test domains are in whitelist:"
            echo "www.example.com in whitelist: $(jq -r '.whitelists[].endpoints[] | select(.domain != null) | .domain' ~/auto_whitelist.json 2>/dev/null | grep -q "example.com" && echo "YES" || echo "NO")"
            echo "httpbin.org in whitelist: $(jq -r '.whitelists[].endpoints[] | select(.domain != null) | .domain' ~/auto_whitelist.json 2>/dev/null | grep -q "httpbin.org" && echo "YES" || echo "NO")"
          else
            echo "⚠️  Whitelist file not found!"
          fi

      - name: Simulate Network Traffic - Iteration 8 (Unauthorized)
        if: steps.iteration-8-fail.outcome != 'failure'
        run: |
          echo "Simulating iteration 8 network traffic patterns (ENFORCEMENT MODE - includes unauthorized endpoint)..."
          echo "Making connections to whitelisted endpoints..."
          # Some whitelisted endpoints
          curl -s --max-time 5 https://www.github.com > /dev/null || true
          curl -s --max-time 5 https://registry.npmjs.org > /dev/null || true
          echo "Making connections to UNAUTHORIZED endpoints (should trigger violation)..."
          # Add UNAUTHORIZED endpoint (not in whitelist)
          curl -s --max-time 5 https://www.example.com > /dev/null || true
          curl -s --max-time 5 https://httpbin.org > /dev/null || true
          echo "Waiting for traffic to be captured..."
          sleep 5

      - name: Dump Sessions - Iteration 8 (Detailed)
        if: always()
        run: |
          echo "=== Iteration 8 Session Logs (DETAILED) ==="
          if command -v edamame_posture &> /dev/null; then
            echo "Getting all sessions..."
            echo ""
            echo "--- Full session output ---"
            edamame_posture get-sessions || echo "get-sessions exited with code: $?"
            echo ""
            echo "--- Checking for exceptions ---"
            edamame_posture get-exceptions || echo "get-exceptions exited with code: $?"
            echo ""
            echo "--- Checking for non-conforming sessions ---"
            edamame_posture get-sessions 2>&1 | grep -i "nonconforming\|exception\|violation" || echo "No violations found in output"
          else
            echo "edamame_posture not available"
          fi

      - name: Check Whitelist Enforcement Status
        if: always()
        run: |
          echo "=== Iteration 8 Enforcement Status Check ==="
          echo "Action outcome: ${{ steps.iteration-8-fail.outcome }}"
          echo "Action exit code: ${{ steps.iteration-8-fail.outcome == 'failure' && 'non-zero (expected)' || 'zero (unexpected)' }}"
          echo ""
          echo "Checking if whitelist is in enforcement mode..."
          if [[ -f ~/auto_whitelist_stable_count.txt ]]; then
            STABLE_COUNT=$(cat ~/auto_whitelist_stable_count.txt)
            echo "Stable count: $STABLE_COUNT"
            if [[ "$STABLE_COUNT" -ge "3" ]]; then
              echo "✅ Whitelist should be in enforcement mode (stable count >= 3)"
            else
              echo "⚠️  Whitelist may not be in enforcement mode (stable count < 3)"
            fi
          else
            echo "⚠️  Stable count file not found"
          fi

      - name: Verify Iteration 8 Fail Status
        if: always()
        run: |
          echo "=== Iteration 8 Verification (Enforcement Fail) ==="
          echo ""
          if [[ "${{ steps.iteration-8-fail.outcome }}" == "failure" ]]; then
            echo "✅ EXPECTED: Workflow failed due to whitelist violations"
            echo "Exit code was non-zero (as expected)"
            echo "Unauthorized endpoints were detected and blocked"
          else
            echo "⚠️  UNEXPECTED: Workflow did not fail"
            echo "This might indicate enforcement is not working correctly"
            echo "Or the unauthorized endpoints were not detected"
            echo ""
            echo "Debugging information:"
            echo "- Action outcome: ${{ steps.iteration-8-fail.outcome }}"
            echo "- Check session logs above for details"
            echo "- Verify whitelist contains expected domains"
            echo "- Check if exit_on_whitelist_exceptions is enabled"
          fi

  # Final summary job
  test-summary:
    timeout-minutes: 5
    needs: 
      - auto-whitelist-iteration-1
      - auto-whitelist-iteration-2
      - auto-whitelist-iteration-3
      - auto-whitelist-iteration-4
      - auto-whitelist-iteration-5
      - auto-whitelist-iteration-6
      - auto-whitelist-iteration-7-enforcement-pass
      - auto-whitelist-iteration-8-enforcement-fail
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Test Results Summary
        run: |
          echo "## Auto-Whitelist Complex Test Results"
          echo ""
          echo "### Iteration Results:"
          echo "- Iteration 1 (Initial): ${{ needs.auto-whitelist-iteration-1.result }}"
          echo "- Iteration 2 (Augment): ${{ needs.auto-whitelist-iteration-2.result }}"
          echo "- Iteration 3 (Augment): ${{ needs.auto-whitelist-iteration-3.result }}"
          echo "- Iteration 4 (Stable 1): ${{ needs.auto-whitelist-iteration-4.result }}"
          echo "- Iteration 5 (Stable 2): ${{ needs.auto-whitelist-iteration-5.result }}"
          echo "- Iteration 6 (Stable 3): ${{ needs.auto-whitelist-iteration-6.result }}"
          echo "- Iteration 7 (Enforcement Pass): ${{ needs.auto-whitelist-iteration-7-enforcement-pass.result }}"
          echo "- Iteration 8 (Enforcement Fail): ${{ needs.auto-whitelist-iteration-8-enforcement-fail.result }}"
          echo ""
          echo "### Expected Behavior:"
          echo "1. ✅ Iteration 1: Creates initial whitelist (listen-only)"
          echo "2. ✅ Iteration 2-3: Augments whitelist with new endpoints"
          echo "3. ✅ Iteration 4-6: Three consecutive stable runs (0% change)"
          echo "4. ✅ Iteration 7: Enforcement mode allows whitelisted traffic"
          echo "5. ✅ Iteration 8: Enforcement mode blocks unauthorized traffic"
          echo ""
          
          # Determine overall test status
          if [[ "${{ needs.auto-whitelist-iteration-1.result }}" != "success" ]] || \
             [[ "${{ needs.auto-whitelist-iteration-2.result }}" != "success" ]] || \
             [[ "${{ needs.auto-whitelist-iteration-3.result }}" != "success" ]] || \
             [[ "${{ needs.auto-whitelist-iteration-4.result }}" != "success" ]] || \
             [[ "${{ needs.auto-whitelist-iteration-5.result }}" != "success" ]] || \
             [[ "${{ needs.auto-whitelist-iteration-6.result }}" != "success" ]] || \
             [[ "${{ needs.auto-whitelist-iteration-7-enforcement-pass.result }}" != "success" ]] || \
             [[ "${{ needs.auto-whitelist-iteration-8-enforcement-fail.result }}" != "failure" ]]; then
            echo "❌ Some test iterations did not behave as expected"
            exit 1
          else
            echo "✅ All test iterations completed as expected!"
          fi

      - name: Slack alerts
        if: |
          needs.auto-whitelist-iteration-1.result != 'success' || 
          needs.auto-whitelist-iteration-2.result != 'success' || 
          needs.auto-whitelist-iteration-3.result != 'success' || 
          needs.auto-whitelist-iteration-4.result != 'success' || 
          needs.auto-whitelist-iteration-5.result != 'success' || 
          needs.auto-whitelist-iteration-6.result != 'success' || 
          needs.auto-whitelist-iteration-7-enforcement-pass.result != 'success' || 
          needs.auto-whitelist-iteration-8-enforcement-fail.result != 'failure'
        uses: slackapi/slack-github-action@v1.26.0
        with:
          channel-id: 'C072J0U9TH7'
          slack-message: |
            *Auto-Whitelist Complex Test Results for ${{ github.repository }}*:
            - Iteration 1 (Initial): ${{ needs.auto-whitelist-iteration-1.result == 'success' && '✅ Success' || '❌ Failed' }}
            - Iteration 2 (Augment): ${{ needs.auto-whitelist-iteration-2.result == 'success' && '✅ Success' || '❌ Failed' }}
            - Iteration 3 (Augment): ${{ needs.auto-whitelist-iteration-3.result == 'success' && '✅ Success' || '❌ Failed' }}
            - Iteration 4 (Stable 1): ${{ needs.auto-whitelist-iteration-4.result == 'success' && '✅ Success' || '❌ Failed' }}
            - Iteration 5 (Stable 2): ${{ needs.auto-whitelist-iteration-5.result == 'success' && '✅ Success' || '❌ Failed' }}
            - Iteration 6 (Stable 3): ${{ needs.auto-whitelist-iteration-6.result == 'success' && '✅ Success' || '❌ Failed' }}
            - Iteration 7 (Enforcement Pass): ${{ needs.auto-whitelist-iteration-7-enforcement-pass.result == 'success' && '✅ Success' || '❌ Failed' }}
            - Iteration 8 (Enforcement Fail): ${{ needs.auto-whitelist-iteration-8-enforcement-fail.result == 'failure' && '✅ Success (failed as expected)' || '❌ Unexpected' }}
            Branch: ${{ github.ref }}
            More details: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}

      - name: Fail job if tests failed
        if: |
          needs.auto-whitelist-iteration-1.result != 'success' || 
          needs.auto-whitelist-iteration-2.result != 'success' || 
          needs.auto-whitelist-iteration-3.result != 'success' || 
          needs.auto-whitelist-iteration-4.result != 'success' || 
          needs.auto-whitelist-iteration-5.result != 'success' || 
          needs.auto-whitelist-iteration-6.result != 'success' || 
          needs.auto-whitelist-iteration-7-enforcement-pass.result != 'success' || 
          needs.auto-whitelist-iteration-8-enforcement-fail.result != 'failure'
        run: |
          echo "## Test Results Summary"
          echo "Some test iterations did not behave as expected."
          echo ""
          echo "Forcing job to fail because tests did not succeed."
          exit 1

