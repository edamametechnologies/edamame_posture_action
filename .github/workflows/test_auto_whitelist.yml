name: Test Auto-Whitelist Complex

# This workflow exercises the auto-whitelist lifecycle end-to-end within a single
# job by repeatedly invoking the EDAMAME Posture action. Each “iteration” mirrors
# a subsequent workflow run: the whitelist state is restored before the action
# runs, traffic is generated while the background process is active, the action
# captures and evaluates sessions, and the updated whitelist state is persisted.
# The goal is to simulate the real-world progression from listen-only mode,
# through augmentation, into stability, and finally enforcement (including a
# negative test with unauthorized traffic).

on:
  workflow_dispatch:
    inputs:
      reset_artifact:
        description: 'Delete existing auto-whitelist artifact to start fresh'
        required: false
        default: false
        type: boolean
  push:
    branches:
      - 'dev'
      - 'main'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  actions: write

jobs:
  auto-whitelist-lifecycle:
    name: Auto-Whitelist Lifecycle Simulation
    runs-on: ubuntu-latest
    timeout-minutes: 45
    env:
      AUTO_WHITELIST_ARTIFACT: test-complex-auto-whitelist-e2e
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Derive auto-whitelist environment
        run: |
          echo "AUTO_WHITELIST_STATE_DIR=$RUNNER_TEMP/auto-whitelist-state" >> $GITHUB_ENV
          echo "AUTO_WHITELIST_ARTIFACT=$AUTO_WHITELIST_ARTIFACT"
          echo "AUTO_WHITELIST_STATE_DIR=$RUNNER_TEMP/auto-whitelist-state"


      - name: Clean up existing auto-whitelist artifact
        if: github.event_name == 'workflow_dispatch' && inputs.reset_artifact == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        continue-on-error: true
        run: |
          echo "Cleaning up existing auto-whitelist artifact..."
          ARTIFACT_NAME="${AUTO_WHITELIST_ARTIFACT}"
          ARTIFACT_IDS=$(gh api repos/${{ github.repository }}/actions/artifacts --paginate --jq ".artifacts[] | select(.name == \"$ARTIFACT_NAME\") | .id" 2>/dev/null || true)
          if [[ -n "$ARTIFACT_IDS" ]]; then
            echo "$ARTIFACT_IDS" | while read -r ARTIFACT_ID; do
              [[ -n "$ARTIFACT_ID" ]] || continue
              echo "Deleting artifact id $ARTIFACT_ID"
              gh api repos/${{ github.repository }}/actions/artifacts/$ARTIFACT_ID -X DELETE 2>/dev/null || echo "Failed to delete (maybe already expired)"
            done
          else
            echo "No artifacts named $ARTIFACT_NAME found"
          fi

      - name: Initialize auto-whitelist state
        run: |
          rm -f $HOME/auto_whitelist.json ~/auto_whitelist_iteration.txt ~/auto_whitelist_stable_count.txt
          rm -rf "$AUTO_WHITELIST_STATE_DIR"
          mkdir -p "$AUTO_WHITELIST_STATE_DIR/latest"
          echo "Initialized state directory: $AUTO_WHITELIST_STATE_DIR"

      # Iteration 1 -------------------------------------------------------------------
      - name: Iteration 1 - Start auto-whitelist (listen-only)
        id: iteration1-start
        uses: ./
        with:
          disconnected_mode: true
          network_scan: true
          packet_capture: true
          auto_whitelist: true
          auto_whitelist_artifact_name: ${{ env.AUTO_WHITELIST_ARTIFACT }}
          auto_whitelist_stability_threshold: "0"
          auto_whitelist_stability_consecutive_runs: "3"
          auto_whitelist_max_iterations: "10"
          dump_sessions_log: false
          exit_on_whitelist_exceptions: false
          display_logs: false

      - name: Iteration 1 - Wait for capture readiness
        if: steps.iteration1-start.outcome == 'success'
        run: |
          echo "Waiting for background process to settle..."
          if [[ -n "${EDAMAME_POSTURE_CMD:-}" ]]; then
            $EDAMAME_POSTURE_CMD wait-for-connection 30 || true
          elif command -v edamame_posture &> /dev/null; then
            edamame_posture wait-for-connection 30 || true
          elif [[ -f ~/edamame_posture ]]; then
            ~/edamame_posture wait-for-connection 30 || true
          else
            echo "EDAMAME_POSTURE_CMD not available; skipping explicit wait"
          fi
          sleep 5

      - name: Iteration 1 - Simulate baseline traffic
        if: steps.iteration1-start.outcome == 'success'
        run: |
          echo "Simulating baseline traffic (seed initial whitelist)..."
          curl -s --max-time 5 https://www.github.com > /dev/null || true
          curl -s --max-time 5 https://registry.npmjs.org > /dev/null || true
          curl -s --max-time 5 https://api.github.com > /dev/null || true
          sleep 15

      - name: Iteration 1 - Finalize auto-whitelist
        id: iteration1-finalize
        if: steps.iteration1-start.outcome == 'success'
        uses: ./
        with:
          auto_whitelist: true
          auto_whitelist_artifact_name: ${{ env.AUTO_WHITELIST_ARTIFACT }}
          auto_whitelist_stability_threshold: "0"
          auto_whitelist_stability_consecutive_runs: "3"
          auto_whitelist_max_iterations: "10"
          dump_sessions_log: true
          exit_on_whitelist_exceptions: false
          display_logs: true

      - name: Iteration 1 - Stop EDAMAME Posture
        if: steps.iteration1-start.outcome == 'success'
        uses: ./
        with:
          stop: true
          display_logs: false
        continue-on-error: true

      - name: Iteration 1 - Persist auto-whitelist state
        if: steps.iteration1-start.outcome == 'success'
        run: |
          mkdir -p "$AUTO_WHITELIST_STATE_DIR/iteration-1" "$AUTO_WHITELIST_STATE_DIR/latest"
          rm -f "$AUTO_WHITELIST_STATE_DIR/iteration-1"/auto_whitelist* "$AUTO_WHITELIST_STATE_DIR/latest"/auto_whitelist* 2>/dev/null || true
          shopt -s nullglob
          for file in "$HOME"/auto_whitelist*.json "$HOME"/auto_whitelist*.txt; do
            cp "$file" "$AUTO_WHITELIST_STATE_DIR/iteration-1/"
            cp "$file" "$AUTO_WHITELIST_STATE_DIR/latest/"
          done
          shopt -u nullglob
          ls -la "$AUTO_WHITELIST_STATE_DIR/iteration-1" || true
      - name: Iteration 1 - Validate whitelist contents
        if: steps.iteration1-start.outcome == 'success'
        run: |
          if [[ ! -s $HOME/auto_whitelist.json ]]; then
            echo 'auto_whitelist.json is missing or empty' >&2
            ls -la ~/*.json ~/*.txt 2>/dev/null || true
            exit 1
          fi
          COUNT=$(jq -r '([.whitelists[].endpoints | length] | add) // 0' $HOME/auto_whitelist.json 2>/dev/null || echo '0')
          echo "Endpoint count: $COUNT"
          if [[ "$COUNT" == "0" ]]; then
            echo 'Whitelist contains no endpoints' >&2
            head $HOME/auto_whitelist.json || cat $HOME/auto_whitelist.json
            exit 1
          fi

      - name: Iteration 1 - Summary
        if: steps.iteration1-start.outcome == 'success'
        run: |
          echo "Iteration file iteration: $(cat ~/auto_whitelist_iteration.txt 2>/dev/null || echo 'unknown')"
          echo "Stable count           : $(cat ~/auto_whitelist_stable_count.txt 2>/dev/null || echo '0')"

      # Iteration 2 -------------------------------------------------------------------
      - name: Iteration 2 - Restore previous state
        run: |
          echo "Restoring whitelist state from iteration 1..."
          shopt -s nullglob
          for file in "$AUTO_WHITELIST_STATE_DIR/latest"/auto_whitelist*.json "$AUTO_WHITELIST_STATE_DIR/latest"/auto_whitelist*.txt; do
            cp "$file" ~/
          done
          shopt -u nullglob
          ls -la ~/auto_whitelist*.json ~/auto_whitelist*.txt 2>/dev/null || echo "No files restored"

      - name: Iteration 2 - Start auto-whitelist
        id: iteration2-start
        uses: ./
        with:
          disconnected_mode: true
          network_scan: true
          packet_capture: true
          auto_whitelist: true
          auto_whitelist_artifact_name: ${{ env.AUTO_WHITELIST_ARTIFACT }}
          auto_whitelist_stability_threshold: "0"
          auto_whitelist_stability_consecutive_runs: "3"
          auto_whitelist_max_iterations: "10"
          dump_sessions_log: false
          exit_on_whitelist_exceptions: false
          display_logs: false

      - name: Iteration 2 - Wait for capture readiness
        if: steps.iteration2-start.outcome == 'success'
        run: |
          echo "Waiting for background process to settle..."
          if [[ -n "${EDAMAME_POSTURE_CMD:-}" ]]; then
            $EDAMAME_POSTURE_CMD wait-for-connection 30 || true
          elif command -v edamame_posture &> /dev/null; then
            edamame_posture wait-for-connection 30 || true
          elif [[ -f ~/edamame_posture ]]; then
            ~/edamame_posture wait-for-connection 30 || true
          else
            echo "EDAMAME_POSTURE_CMD not available; skipping explicit wait"
          fi
          sleep 5

      - name: Iteration 2 - Simulate augmentation traffic
        if: steps.iteration2-start.outcome == 'success'
        run: |
          echo "Simulating baseline + new endpoints..."
          curl -s --max-time 5 https://www.github.com > /dev/null || true
          curl -s --max-time 5 https://registry.npmjs.org > /dev/null || true
          curl -s --max-time 5 https://api.github.com > /dev/null || true
          curl -s --max-time 5 https://www.npmjs.com > /dev/null || true
          curl -s --max-time 5 https://cdn.jsdelivr.net > /dev/null || true
          sleep 15

      - name: Iteration 2 - Finalize auto-whitelist
        id: iteration2-finalize
        if: steps.iteration2-start.outcome == 'success'
        uses: ./
        with:
          auto_whitelist: true
          auto_whitelist_artifact_name: ${{ env.AUTO_WHITELIST_ARTIFACT }}
          auto_whitelist_stability_threshold: "0"
          auto_whitelist_stability_consecutive_runs: "3"
          auto_whitelist_max_iterations: "10"
          dump_sessions_log: true
          exit_on_whitelist_exceptions: false
          set_custom_whitelists: true
          custom_whitelists_path: $HOME/auto_whitelist.json
          display_logs: true

      - name: Iteration 2 - Stop EDAMAME Posture
        if: steps.iteration2-start.outcome == 'success'
        uses: ./
        with:
          stop: true
          display_logs: false
        continue-on-error: true

      - name: Iteration 2 - Persist auto-whitelist state
        if: steps.iteration2-start.outcome == 'success'
        run: |
          mkdir -p "$AUTO_WHITELIST_STATE_DIR/iteration-2" "$AUTO_WHITELIST_STATE_DIR/latest"
          rm -f "$AUTO_WHITELIST_STATE_DIR/iteration-2"/auto_whitelist* "$AUTO_WHITELIST_STATE_DIR/latest"/auto_whitelist* 2>/dev/null || true
          shopt -s nullglob
          for file in "$HOME"/auto_whitelist*.json "$HOME"/auto_whitelist*.txt; do
            cp "$file" "$AUTO_WHITELIST_STATE_DIR/iteration-2/"
            cp "$file" "$AUTO_WHITELIST_STATE_DIR/latest/"
          done
          shopt -u nullglob
          ls -la "$AUTO_WHITELIST_STATE_DIR/iteration-2" || true
      - name: Iteration 2 - Validate whitelist contents
        if: steps.iteration2-start.outcome == 'success'
        run: |
          if [[ ! -s $HOME/auto_whitelist.json ]]; then
            echo 'auto_whitelist.json is missing or empty' >&2
            ls -la ~/*.json ~/*.txt 2>/dev/null || true
            exit 1
          fi
          COUNT=$(jq -r '([.whitelists[].endpoints | length] | add) // 0' $HOME/auto_whitelist.json 2>/dev/null || echo '0')
          echo "Endpoint count: $COUNT"
          if [[ "$COUNT" == "0" ]]; then
            echo 'Whitelist contains no endpoints' >&2
            head $HOME/auto_whitelist.json || cat $HOME/auto_whitelist.json
            exit 1
          fi

      - name: Iteration 2 - Summary
        if: steps.iteration2-start.outcome == 'success'
        run: |
          echo "Iteration file iteration: $(cat ~/auto_whitelist_iteration.txt 2>/dev/null || echo 'unknown')"
          echo "Stable count           : $(cat ~/auto_whitelist_stable_count.txt 2>/dev/null || echo '0')"

      # Iteration 3 -------------------------------------------------------------------
      - name: Iteration 3 - Restore previous state
        run: |
          echo "Restoring whitelist state from iteration 2..."
          shopt -s nullglob
          for file in "$AUTO_WHITELIST_STATE_DIR/latest"/auto_whitelist*.json "$AUTO_WHITELIST_STATE_DIR/latest"/auto_whitelist*.txt; do
            cp "$file" ~/
          done
          shopt -u nullglob
          ls -la ~/auto_whitelist*.json ~/auto_whitelist*.txt 2>/dev/null || echo "No files restored"

      - name: Iteration 3 - Start auto-whitelist
        id: iteration3-start
        uses: ./
        with:
          disconnected_mode: true
          network_scan: true
          packet_capture: true
          auto_whitelist: true
          auto_whitelist_artifact_name: ${{ env.AUTO_WHITELIST_ARTIFACT }}
          auto_whitelist_stability_threshold: "0"
          auto_whitelist_stability_consecutive_runs: "3"
          auto_whitelist_max_iterations: "10"
          dump_sessions_log: false
          exit_on_whitelist_exceptions: false
          display_logs: false

      - name: Iteration 3 - Wait for capture readiness
        if: steps.iteration3-start.outcome == 'success'
        run: |
          echo "Waiting for background process to settle..."
          if [[ -n "${EDAMAME_POSTURE_CMD:-}" ]]; then
            $EDAMAME_POSTURE_CMD wait-for-connection 30 || true
          elif command -v edamame_posture &> /dev/null; then
            edamame_posture wait-for-connection 30 || true
          elif [[ -f ~/edamame_posture ]]; then
            ~/edamame_posture wait-for-connection 30 || true
          else
            echo "EDAMAME_POSTURE_CMD not available; skipping explicit wait"
          fi
          sleep 5

      - name: Iteration 3 - Simulate additional augmentation traffic
        if: steps.iteration3-start.outcome == 'success'
        run: |
          echo "Simulating baseline + previous + additional endpoints..."
          curl -s --max-time 5 https://www.github.com > /dev/null || true
          curl -s --max-time 5 https://registry.npmjs.org > /dev/null || true
          curl -s --max-time 5 https://api.github.com > /dev/null || true
          curl -s --max-time 5 https://www.npmjs.com > /dev/null || true
          curl -s --max-time 5 https://cdn.jsdelivr.net > /dev/null || true
          curl -s --max-time 5 https://fonts.googleapis.com > /dev/null || true
          curl -s --max-time 5 https://www.google-analytics.com > /dev/null || true
          sleep 15

      - name: Iteration 3 - Finalize auto-whitelist
        id: iteration3-finalize
        if: steps.iteration3-start.outcome == 'success'
        uses: ./
        with:
          auto_whitelist: true
          auto_whitelist_artifact_name: ${{ env.AUTO_WHITELIST_ARTIFACT }}
          auto_whitelist_stability_threshold: "0"
          auto_whitelist_stability_consecutive_runs: "3"
          auto_whitelist_max_iterations: "10"
          dump_sessions_log: true
          exit_on_whitelist_exceptions: false
          set_custom_whitelists: true
          custom_whitelists_path: $HOME/auto_whitelist.json
          display_logs: true

      - name: Iteration 3 - Stop EDAMAME Posture
        if: steps.iteration3-start.outcome == 'success'
        uses: ./
        with:
          stop: true
          display_logs: false
        continue-on-error: true

      - name: Iteration 3 - Persist auto-whitelist state
        if: steps.iteration3-start.outcome == 'success'
        run: |
          mkdir -p "$AUTO_WHITELIST_STATE_DIR/iteration-3" "$AUTO_WHITELIST_STATE_DIR/latest"
          rm -f "$AUTO_WHITELIST_STATE_DIR/iteration-3"/auto_whitelist* "$AUTO_WHITELIST_STATE_DIR/latest"/auto_whitelist* 2>/dev/null || true
          shopt -s nullglob
          for file in "$HOME"/auto_whitelist*.json "$HOME"/auto_whitelist*.txt; do
            cp "$file" "$AUTO_WHITELIST_STATE_DIR/iteration-3/"
            cp "$file" "$AUTO_WHITELIST_STATE_DIR/latest/"
          done
          shopt -u nullglob
          ls -la "$AUTO_WHITELIST_STATE_DIR/iteration-3" || true
      - name: Iteration 3 - Validate whitelist contents
        if: steps.iteration3-start.outcome == 'success'
        run: |
          if [[ ! -s $HOME/auto_whitelist.json ]]; then
            echo 'auto_whitelist.json is missing or empty' >&2
            ls -la ~/*.json ~/*.txt 2>/dev/null || true
            exit 1
          fi
          COUNT=$(jq -r '([.whitelists[].endpoints | length] | add) // 0' $HOME/auto_whitelist.json 2>/dev/null || echo '0')
          echo "Endpoint count: $COUNT"
          if [[ "$COUNT" == "0" ]]; then
            echo 'Whitelist contains no endpoints' >&2
            head $HOME/auto_whitelist.json || cat $HOME/auto_whitelist.json
            exit 1
          fi

      - name: Iteration 3 - Summary
        if: steps.iteration3-start.outcome == 'success'
        run: |
          echo "Iteration file iteration: $(cat ~/auto_whitelist_iteration.txt 2>/dev/null || echo 'unknown')"
          echo "Stable count           : $(cat ~/auto_whitelist_stable_count.txt 2>/dev/null || echo '0')"

      # Iteration 4 -------------------------------------------------------------------
      - name: Iteration 4 - Restore previous state
        run: |
          echo "Restoring whitelist state from iteration 3..."
          shopt -s nullglob
          for file in "$AUTO_WHITELIST_STATE_DIR/latest"/auto_whitelist*.json "$AUTO_WHITELIST_STATE_DIR/latest"/auto_whitelist*.txt; do
            cp "$file" ~/
          done
          shopt -u nullglob
          ls -la ~/auto_whitelist*.json ~/auto_whitelist*.txt 2>/dev/null || echo "No files restored"

      - name: Iteration 4 - Start auto-whitelist (stability confirmation 1/3)
        id: iteration4-start
        uses: ./
        with:
          disconnected_mode: true
          network_scan: true
          packet_capture: true
          auto_whitelist: true
          auto_whitelist_artifact_name: ${{ env.AUTO_WHITELIST_ARTIFACT }}
          auto_whitelist_stability_threshold: "0"
          auto_whitelist_stability_consecutive_runs: "3"
          auto_whitelist_max_iterations: "10"
          dump_sessions_log: false
          exit_on_whitelist_exceptions: false
          display_logs: false

      - name: Iteration 4 - Wait for capture readiness
        if: steps.iteration4-start.outcome == 'success'
        run: |
          echo "Waiting for background process to settle..."
          if [[ -n "${EDAMAME_POSTURE_CMD:-}" ]]; then
            $EDAMAME_POSTURE_CMD wait-for-connection 30 || true
          elif command -v edamame_posture &> /dev/null; then
            edamame_posture wait-for-connection 30 || true
          elif [[ -f ~/edamame_posture ]]; then
            ~/edamame_posture wait-for-connection 30 || true
          else
            echo "EDAMAME_POSTURE_CMD not available; skipping explicit wait"
          fi
          sleep 5

      - name: Iteration 4 - Simulate stable traffic
        if: steps.iteration4-start.outcome == 'success'
        run: |
          echo "Replaying stable traffic set..."
          for url in \
            https://www.github.com \
            https://registry.npmjs.org \
            https://api.github.com \
            https://www.npmjs.com \
            https://cdn.jsdelivr.net \
            https://fonts.googleapis.com \
            https://www.google-analytics.com
          do
            curl -s --max-time 5 "$url" > /dev/null || true
          done
          sleep 15

      - name: Iteration 4 - Finalize auto-whitelist
        id: iteration4-finalize
        if: steps.iteration4-start.outcome == 'success'
        uses: ./
        with:
          auto_whitelist: true
          auto_whitelist_artifact_name: ${{ env.AUTO_WHITELIST_ARTIFACT }}
          auto_whitelist_stability_threshold: "0"
          auto_whitelist_stability_consecutive_runs: "3"
          auto_whitelist_max_iterations: "10"
          dump_sessions_log: true
          exit_on_whitelist_exceptions: false
          set_custom_whitelists: true
          custom_whitelists_path: $HOME/auto_whitelist.json
          display_logs: true

      - name: Iteration 4 - Stop EDAMAME Posture
        if: steps.iteration4-start.outcome == 'success'
        uses: ./
        with:
          stop: true
          display_logs: false
        continue-on-error: true

      - name: Iteration 4 - Persist auto-whitelist state
        if: steps.iteration4-start.outcome == 'success'
        run: |
          mkdir -p "$AUTO_WHITELIST_STATE_DIR/iteration-4" "$AUTO_WHITELIST_STATE_DIR/latest"
          rm -f "$AUTO_WHITELIST_STATE_DIR/iteration-4"/auto_whitelist* "$AUTO_WHITELIST_STATE_DIR/latest"/auto_whitelist* 2>/dev/null || true
          shopt -s nullglob
          for file in "$HOME"/auto_whitelist*.json "$HOME"/auto_whitelist*.txt; do
            cp "$file" "$AUTO_WHITELIST_STATE_DIR/iteration-4/"
            cp "$file" "$AUTO_WHITELIST_STATE_DIR/latest/"
          done
          shopt -u nullglob
          ls -la "$AUTO_WHITELIST_STATE_DIR/iteration-4" || true
      - name: Iteration 4 - Validate whitelist contents
        if: steps.iteration4-start.outcome == 'success'
        run: |
          if [[ ! -s $HOME/auto_whitelist.json ]]; then
            echo 'auto_whitelist.json is missing or empty' >&2
            ls -la ~/*.json ~/*.txt 2>/dev/null || true
            exit 1
          fi
          COUNT=$(jq -r '([.whitelists[].endpoints | length] | add) // 0' $HOME/auto_whitelist.json 2>/dev/null || echo '0')
          echo "Endpoint count: $COUNT"
          if [[ "$COUNT" == "0" ]]; then
            echo 'Whitelist contains no endpoints' >&2
            head $HOME/auto_whitelist.json || cat $HOME/auto_whitelist.json
            exit 1
          fi

      - name: Iteration 4 - Summary
        if: steps.iteration4-start.outcome == 'success'
        run: |
          echo "Iteration file iteration: $(cat ~/auto_whitelist_iteration.txt 2>/dev/null || echo 'unknown')"
          echo "Stable count           : $(cat ~/auto_whitelist_stable_count.txt 2>/dev/null || echo '0')"

      # Iteration 5 -------------------------------------------------------------------
      - name: Iteration 5 - Restore previous state
        run: |
          echo "Restoring whitelist state from iteration 4..."
          shopt -s nullglob
          for file in "$AUTO_WHITELIST_STATE_DIR/latest"/auto_whitelist*.json "$AUTO_WHITELIST_STATE_DIR/latest"/auto_whitelist*.txt; do
            cp "$file" ~/
          done
          shopt -u nullglob
          ls -la ~/auto_whitelist*.json ~/auto_whitelist*.txt 2>/dev/null || echo "No files restored"

      - name: Iteration 5 - Start auto-whitelist (stability confirmation 2/3)
        id: iteration5-start
        uses: ./
        with:
          disconnected_mode: true
          network_scan: true
          packet_capture: true
          auto_whitelist: true
          auto_whitelist_artifact_name: ${{ env.AUTO_WHITELIST_ARTIFACT }}
          auto_whitelist_stability_threshold: "0"
          auto_whitelist_stability_consecutive_runs: "3"
          auto_whitelist_max_iterations: "10"
          dump_sessions_log: false
          exit_on_whitelist_exceptions: false
          display_logs: false

      - name: Iteration 5 - Wait for capture readiness
        if: steps.iteration5-start.outcome == 'success'
        run: |
          echo "Waiting for background process to settle..."
          if [[ -n "${EDAMAME_POSTURE_CMD:-}" ]]; then
            $EDAMAME_POSTURE_CMD wait-for-connection 30 || true
          elif command -v edamame_posture &> /dev/null; then
            edamame_posture wait-for-connection 30 || true
          elif [[ -f ~/edamame_posture ]]; then
            ~/edamame_posture wait-for-connection 30 || true
          else
            echo "EDAMAME_POSTURE_CMD not available; skipping explicit wait"
          fi
          sleep 5

      - name: Iteration 5 - Simulate stable traffic
        if: steps.iteration5-start.outcome == 'success'
        run: |
          echo "Replaying stable traffic set..."
          for url in \
            https://www.github.com \
            https://registry.npmjs.org \
            https://api.github.com \
            https://www.npmjs.com \
            https://cdn.jsdelivr.net \
            https://fonts.googleapis.com \
            https://www.google-analytics.com
          do
            curl -s --max-time 5 "$url" > /dev/null || true
          done
          sleep 15

      - name: Iteration 5 - Finalize auto-whitelist
        id: iteration5-finalize
        if: steps.iteration5-start.outcome == 'success'
        uses: ./
        with:
          auto_whitelist: true
          auto_whitelist_artifact_name: ${{ env.AUTO_WHITELIST_ARTIFACT }}
          auto_whitelist_stability_threshold: "0"
          auto_whitelist_stability_consecutive_runs: "3"
          auto_whitelist_max_iterations: "10"
          dump_sessions_log: true
          exit_on_whitelist_exceptions: false
          set_custom_whitelists: true
          custom_whitelists_path: $HOME/auto_whitelist.json
          display_logs: true

      - name: Iteration 5 - Stop EDAMAME Posture
        if: steps.iteration5-start.outcome == 'success'
        uses: ./
        with:
          stop: true
          display_logs: false
        continue-on-error: true

      - name: Iteration 5 - Persist auto-whitelist state
        if: steps.iteration5-start.outcome == 'success'
        run: |
          mkdir -p "$AUTO_WHITELIST_STATE_DIR/iteration-5" "$AUTO_WHITELIST_STATE_DIR/latest"
          rm -f "$AUTO_WHITELIST_STATE_DIR/iteration-5"/auto_whitelist* "$AUTO_WHITELIST_STATE_DIR/latest"/auto_whitelist* 2>/dev/null || true
          shopt -s nullglob
          for file in "$HOME"/auto_whitelist*.json "$HOME"/auto_whitelist*.txt; do
            cp "$file" "$AUTO_WHITELIST_STATE_DIR/iteration-5/"
            cp "$file" "$AUTO_WHITELIST_STATE_DIR/latest/"
          done
          shopt -u nullglob
          ls -la "$AUTO_WHITELIST_STATE_DIR/iteration-5" || true
      - name: Iteration 5 - Validate whitelist contents
        if: steps.iteration5-start.outcome == 'success'
        run: |
          if [[ ! -s $HOME/auto_whitelist.json ]]; then
            echo 'auto_whitelist.json is missing or empty' >&2
            ls -la ~/*.json ~/*.txt 2>/dev/null || true
            exit 1
          fi
          COUNT=$(jq -r '([.whitelists[].endpoints | length] | add) // 0' $HOME/auto_whitelist.json 2>/dev/null || echo '0')
          echo "Endpoint count: $COUNT"
          if [[ "$COUNT" == "0" ]]; then
            echo 'Whitelist contains no endpoints' >&2
            head $HOME/auto_whitelist.json || cat $HOME/auto_whitelist.json
            exit 1
          fi

      - name: Iteration 5 - Summary
        if: steps.iteration5-start.outcome == 'success'
        run: |
          echo "Iteration file iteration: $(cat ~/auto_whitelist_iteration.txt 2>/dev/null || echo 'unknown')"
          echo "Stable count           : $(cat ~/auto_whitelist_stable_count.txt 2>/dev/null || echo '0')"

      # Iteration 6 -------------------------------------------------------------------
      - name: Iteration 6 - Restore previous state
        run: |
          echo "Restoring whitelist state from iteration 5..."
          shopt -s nullglob
          for file in "$AUTO_WHITELIST_STATE_DIR/latest"/auto_whitelist*.json "$AUTO_WHITELIST_STATE_DIR/latest"/auto_whitelist*.txt; do
            cp "$file" ~/
          done
          shopt -u nullglob
          ls -la ~/auto_whitelist*.json ~/auto_whitelist*.txt 2>/dev/null || echo "No files restored"

      - name: Iteration 6 - Start auto-whitelist (stability confirmation 3/3)
        id: iteration6-start
        uses: ./
        with:
          disconnected_mode: true
          network_scan: true
          packet_capture: true
          auto_whitelist: true
          auto_whitelist_artifact_name: ${{ env.AUTO_WHITELIST_ARTIFACT }}
          auto_whitelist_stability_threshold: "0"
          auto_whitelist_stability_consecutive_runs: "3"
          auto_whitelist_max_iterations: "10"
          dump_sessions_log: false
          exit_on_whitelist_exceptions: false
          display_logs: false

      - name: Iteration 6 - Wait for capture readiness
        if: steps.iteration6-start.outcome == 'success'
        run: |
          echo "Waiting for background process to settle..."
          if [[ -n "${EDAMAME_POSTURE_CMD:-}" ]]; then
            $EDAMAME_POSTURE_CMD wait-for-connection 30 || true
          elif command -v edamame_posture &> /dev/null; then
            edamame_posture wait-for-connection 30 || true
          elif [[ -f ~/edamame_posture ]]; then
            ~/edamame_posture wait-for-connection 30 || true
          else
            echo "EDAMAME_POSTURE_CMD not available; skipping explicit wait"
          fi
          sleep 5

      - name: Iteration 6 - Simulate stable traffic
        if: steps.iteration6-start.outcome == 'success'
        run: |
          echo "Replaying stable traffic set..."
          for url in \
            https://www.github.com \
            https://registry.npmjs.org \
            https://api.github.com \
            https://www.npmjs.com \
            https://cdn.jsdelivr.net \
            https://fonts.googleapis.com \
            https://www.google-analytics.com
          do
            curl -s --max-time 5 "$url" > /dev/null || true
          done
          sleep 15

      - name: Iteration 6 - Finalize auto-whitelist
        id: iteration6-finalize
        if: steps.iteration6-start.outcome == 'success'
        uses: ./
        with:
          auto_whitelist: true
          auto_whitelist_artifact_name: ${{ env.AUTO_WHITELIST_ARTIFACT }}
          auto_whitelist_stability_threshold: "0"
          auto_whitelist_stability_consecutive_runs: "3"
          auto_whitelist_max_iterations: "10"
          dump_sessions_log: true
          exit_on_whitelist_exceptions: false
          set_custom_whitelists: true
          custom_whitelists_path: $HOME/auto_whitelist.json
          display_logs: true

      - name: Iteration 6 - Stop EDAMAME Posture
        if: steps.iteration6-start.outcome == 'success'
        uses: ./
        with:
          stop: true
          display_logs: false
        continue-on-error: true

      - name: Iteration 6 - Persist auto-whitelist state
        if: steps.iteration6-start.outcome == 'success'
        run: |
          mkdir -p "$AUTO_WHITELIST_STATE_DIR/iteration-6" "$AUTO_WHITELIST_STATE_DIR/latest"
          rm -f "$AUTO_WHITELIST_STATE_DIR/iteration-6"/auto_whitelist* "$AUTO_WHITELIST_STATE_DIR/latest"/auto_whitelist* 2>/dev/null || true
          shopt -s nullglob
          for file in "$HOME"/auto_whitelist*.json "$HOME"/auto_whitelist*.txt; do
            cp "$file" "$AUTO_WHITELIST_STATE_DIR/iteration-6/"
            cp "$file" "$AUTO_WHITELIST_STATE_DIR/latest/"
          done
          shopt -u nullglob
          ls -la "$AUTO_WHITELIST_STATE_DIR/iteration-6" || true
      - name: Iteration 6 - Validate whitelist contents
        if: steps.iteration6-start.outcome == 'success'
        run: |
          if [[ ! -s $HOME/auto_whitelist.json ]]; then
            echo 'auto_whitelist.json is missing or empty' >&2
            ls -la ~/*.json ~/*.txt 2>/dev/null || true
            exit 1
          fi
          COUNT=$(jq -r '([.whitelists[].endpoints | length] | add) // 0' $HOME/auto_whitelist.json 2>/dev/null || echo '0')
          echo "Endpoint count: $COUNT"
          if [[ "$COUNT" == "0" ]]; then
            echo 'Whitelist contains no endpoints' >&2
            head $HOME/auto_whitelist.json || cat $HOME/auto_whitelist.json
            exit 1
          fi

      - name: Iteration 6 - Assert whitelist stability
        if: steps.iteration6-start.outcome == 'success'
        run: |
          STABLE_COUNT=$(cat ~/auto_whitelist_stable_count.txt 2>/dev/null || echo "0")
          echo "Stable count reported by action: $STABLE_COUNT"
          if [[ "$STABLE_COUNT" -lt 3 ]]; then
            echo "Expected stable count >= 3 by iteration 6" >&2
            exit 1
          fi

      # Iteration 7 -------------------------------------------------------------------
      - name: Iteration 7 - Restore previous state
        run: |
          echo "Restoring whitelist state from iteration 6..."
          shopt -s nullglob
          for file in "$AUTO_WHITELIST_STATE_DIR/latest"/auto_whitelist*.json "$AUTO_WHITELIST_STATE_DIR/latest"/auto_whitelist*.txt; do
            cp "$file" ~/
          done
          shopt -u nullglob
          ls -la ~/auto_whitelist*.json ~/auto_whitelist*.txt 2>/dev/null || echo "No files restored"

      - name: Iteration 7 - Start auto-whitelist (enforcement expected)
        id: iteration7-start
        uses: ./
        with:
          disconnected_mode: true
          network_scan: true
          packet_capture: true
          auto_whitelist: true
          auto_whitelist_artifact_name: ${{ env.AUTO_WHITELIST_ARTIFACT }}
          auto_whitelist_stability_threshold: "0"
          auto_whitelist_stability_consecutive_runs: "3"
          auto_whitelist_max_iterations: "10"
          dump_sessions_log: false
          exit_on_whitelist_exceptions: false
          display_logs: false

      - name: Iteration 7 - Wait for capture readiness
        if: steps.iteration7-start.outcome == 'success'
        run: |
          echo "Waiting for background process to settle..."
          if [[ -n "${EDAMAME_POSTURE_CMD:-}" ]]; then
            $EDAMAME_POSTURE_CMD wait-for-connection 30 || true
          elif command -v edamame_posture &> /dev/null; then
            edamame_posture wait-for-connection 30 || true
          elif [[ -f ~/edamame_posture ]]; then
            ~/edamame_posture wait-for-connection 30 || true
          else
            echo "EDAMAME_POSTURE_CMD not available; skipping explicit wait"
          fi
          sleep 5

      - name: Iteration 7 - Simulate whitelisted traffic (should pass)
        if: steps.iteration7-start.outcome == 'success'
        run: |
          echo "Replaying whitelisted traffic (enforcement should allow)..."
          for url in \
            https://www.github.com \
            https://registry.npmjs.org \
            https://api.github.com \
            https://www.npmjs.com \
            https://cdn.jsdelivr.net \
            https://fonts.googleapis.com \
            https://www.google-analytics.com
          do
            curl -s --max-time 5 "$url" > /dev/null || true
          done
          sleep 15

      - name: Iteration 7 - Finalize auto-whitelist (enforcement check)
        id: iteration7-finalize
        if: steps.iteration7-start.outcome == 'success'
        uses: ./
        with:
          auto_whitelist: true
          auto_whitelist_artifact_name: ${{ env.AUTO_WHITELIST_ARTIFACT }}
          auto_whitelist_stability_threshold: "0"
          auto_whitelist_stability_consecutive_runs: "3"
          auto_whitelist_max_iterations: "10"
          dump_sessions_log: true
          exit_on_whitelist_exceptions: true
          display_logs: true

      - name: Iteration 7 - Stop EDAMAME Posture
        if: steps.iteration7-start.outcome == 'success'
        uses: ./
        with:
          stop: true
          display_logs: false
        continue-on-error: true

      - name: Iteration 7 - Persist auto-whitelist state
        if: steps.iteration7-start.outcome == 'success'
        run: |
          mkdir -p "$AUTO_WHITELIST_STATE_DIR/iteration-7" "$AUTO_WHITELIST_STATE_DIR/latest"
          rm -f "$AUTO_WHITELIST_STATE_DIR/iteration-7"/auto_whitelist* "$AUTO_WHITELIST_STATE_DIR/latest"/auto_whitelist* 2>/dev/null || true
          shopt -s nullglob
          for file in "$HOME"/auto_whitelist*.json "$HOME"/auto_whitelist*.txt; do
            cp "$file" "$AUTO_WHITELIST_STATE_DIR/iteration-7/"
            cp "$file" "$AUTO_WHITELIST_STATE_DIR/latest/"
          done
          shopt -u nullglob
          ls -la "$AUTO_WHITELIST_STATE_DIR/iteration-7" || true
      - name: Iteration 7 - Validate whitelist contents
        if: steps.iteration7-start.outcome == 'success'
        run: |
          if [[ ! -s $HOME/auto_whitelist.json ]]; then
            echo 'auto_whitelist.json is missing or empty' >&2
            ls -la ~/*.json ~/*.txt 2>/dev/null || true
            exit 1
          fi
          COUNT=$(jq -r '([.whitelists[].endpoints | length] | add) // 0' $HOME/auto_whitelist.json 2>/dev/null || echo '0')
          echo "Endpoint count: $COUNT"
          if [[ "$COUNT" == "0" ]]; then
            echo 'Whitelist contains no endpoints' >&2
            head $HOME/auto_whitelist.json || cat $HOME/auto_whitelist.json
            exit 1
          fi

      - name: Iteration 7 - Summary
        if: steps.iteration7-start.outcome == 'success'
        env:
          ITERATION7_OUTCOME: ${{ steps.iteration7-finalize.outcome }}
        run: |
          echo "Finalizer outcome: $ITERATION7_OUTCOME (expected success)"
          if [[ "$ITERATION7_OUTCOME" != "success" ]]; then
            echo "Iteration 7 was expected to succeed in enforcement mode" >&2
            exit 1
          fi
          echo "Stable count           : $(cat ~/auto_whitelist_stable_count.txt 2>/dev/null || echo 'unknown')"

      # Iteration 8 -------------------------------------------------------------------
      - name: Iteration 8 - Restore previous state
        run: |
          echo "Restoring whitelist state from iteration 7..."
          shopt -s nullglob
          for file in "$AUTO_WHITELIST_STATE_DIR/latest"/auto_whitelist*.json "$AUTO_WHITELIST_STATE_DIR/latest"/auto_whitelist*.txt; do
            cp "$file" ~/
          done
          shopt -u nullglob
          ls -la ~/auto_whitelist*.json ~/auto_whitelist*.txt 2>/dev/null || echo "No files restored"

      - name: Iteration 8 - Start auto-whitelist (enforcement violation expected)
        id: iteration8-start
        uses: ./
        with:
          disconnected_mode: true
          network_scan: true
          packet_capture: true
          auto_whitelist: true
          auto_whitelist_artifact_name: ${{ env.AUTO_WHITELIST_ARTIFACT }}
          auto_whitelist_stability_threshold: "0"
          auto_whitelist_stability_consecutive_runs: "3"
          auto_whitelist_max_iterations: "10"
          dump_sessions_log: false
          exit_on_whitelist_exceptions: false
          display_logs: false

      - name: Iteration 8 - Wait for capture readiness
        if: steps.iteration8-start.outcome == 'success'
        run: |
          echo "Waiting for background process to settle..."
          if [[ -n "${EDAMAME_POSTURE_CMD:-}" ]]; then
            $EDAMAME_POSTURE_CMD wait-for-connection 30 || true
          elif command -v edamame_posture &> /dev/null; then
            edamame_posture wait-for-connection 30 || true
          elif [[ -f ~/edamame_posture ]]; then
            ~/edamame_posture wait-for-connection 30 || true
          else
            echo "EDAMAME_POSTURE_CMD not available; skipping explicit wait"
          fi
          sleep 5

      - name: Iteration 8 - Simulate traffic with violations
        if: steps.iteration8-start.outcome == 'success'
        run: |
          echo "Replaying whitelisted traffic..."
          for url in \
            https://www.github.com \
            https://registry.npmjs.org \
            https://api.github.com \
            https://www.npmjs.com \
            https://cdn.jsdelivr.net \
            https://fonts.googleapis.com \
            https://www.google-analytics.com
          do
            curl -s --max-time 5 "$url" > /dev/null || true
          done
          echo "Sending unauthorized traffic (should trigger enforcement failure)..."
          curl -s --max-time 5 https://www.example.com > /dev/null || true
          curl -s --max-time 5 https://httpbin.org/get > /dev/null || true
          sleep 15

      - name: Iteration 8 - Finalize auto-whitelist (expect failure)
        id: iteration8-finalize
        if: steps.iteration8-start.outcome == 'success'
        uses: ./
        with:
          auto_whitelist: true
          auto_whitelist_artifact_name: ${{ env.AUTO_WHITELIST_ARTIFACT }}
          auto_whitelist_stability_threshold: "0"
          auto_whitelist_stability_consecutive_runs: "3"
          auto_whitelist_max_iterations: "10"
          dump_sessions_log: true
          exit_on_whitelist_exceptions: true
          display_logs: true
        continue-on-error: true

      - name: Iteration 8 - Stop EDAMAME Posture
        if: steps.iteration8-start.outcome == 'success'
        uses: ./
        with:
          stop: true
          display_logs: false
        continue-on-error: true

      - name: Iteration 8 - Verify enforcement failure
        if: steps.iteration8-start.outcome == 'success'
        env:
          ITERATION8_OUTCOME: ${{ steps.iteration8-finalize.outcome }}
        run: |
          echo "Finalizer outcome: $ITERATION8_OUTCOME (expected failure)"
          if [[ "$ITERATION8_OUTCOME" != "failure" ]]; then
            echo "Iteration 8 was expected to fail when unauthorized endpoints appear" >&2
            exit 1
          fi

      - name: Iteration 8 - Persist auto-whitelist state
        if: steps.iteration8-start.outcome == 'success'
        run: |
          mkdir -p "$AUTO_WHITELIST_STATE_DIR/iteration-8" "$AUTO_WHITELIST_STATE_DIR/latest"
          rm -f "$AUTO_WHITELIST_STATE_DIR/iteration-8"/auto_whitelist* "$AUTO_WHITELIST_STATE_DIR/latest"/auto_whitelist* 2>/dev/null || true
          shopt -s nullglob
          for file in "$HOME"/auto_whitelist*.json "$HOME"/auto_whitelist*.txt; do
            cp "$file" "$AUTO_WHITELIST_STATE_DIR/iteration-8/"
            cp "$file" "$AUTO_WHITELIST_STATE_DIR/latest/"
          done
          shopt -u nullglob
          ls -la "$AUTO_WHITELIST_STATE_DIR/iteration-8" || true

      - name: Final Summary
        run: |
          echo "Final iteration marker : $(cat ~/auto_whitelist_iteration.txt 2>/divnull || echo 'unknown')"
          echo "Final stable count     : $(cat ~/auto_whitelist_stable_count.txt 2>/divnull || echo 'unknown')"
          echo "Auto-whitelist files in state directory:"
          ls -la "$AUTO_WHITELIST_STATE_DIR/latest" || true
