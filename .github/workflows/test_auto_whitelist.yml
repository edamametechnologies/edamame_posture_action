name: Test Auto-Whitelist Complex

# This workflow tests the auto-whitelist feature by simulating multiple iterations
# across sequential jobs. Each job represents one "iteration" of the auto-whitelist
# process, simulating what would happen across multiple workflow runs.
#
# Note: The action uses `gh run download` to fetch artifacts from previous workflow
# runs. For testing within a single workflow run, we manually download artifacts
# from previous jobs before the action runs, placing them in ~/ so the action
# can detect them when it checks for existing whitelist files.

on:
  workflow_dispatch:
    inputs:
      reset_artifact:
        description: 'Delete existing auto-whitelist artifact to start fresh'
        required: false
        default: false
        type: boolean
  push:
    branches:
      - 'dev'
      - 'main'

# Auto cancel previous runs if they were not completed.
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

# Declare default permissions as read only.
permissions: read-all

jobs:
  # Iteration 1: Initial whitelist creation (listen-only mode)
  auto-whitelist-iteration-1:
    timeout-minutes: 30
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup EDAMAME Posture - Iteration 1
        id: iteration-1
        uses: ./
        with:
          disconnected_mode: true
          network_scan: true
          packet_capture: true
          auto_whitelist: true
          auto_whitelist_artifact_name: test-complex-auto-whitelist-${{ runner.os }}
          auto_whitelist_stability_threshold: "0"
          auto_whitelist_stability_consecutive_runs: "3"
          auto_whitelist_max_iterations: "10"
          dump_sessions_log: true
          display_logs: false
        continue-on-error: true

      - name: Simulate Network Traffic - Iteration 1
        if: steps.iteration-1.outcome == 'success'
        run: |
          echo "Simulating iteration 1 network traffic patterns..."
          # Simulate basic network connections that should be whitelisted
          curl -s --max-time 5 https://www.github.com > /dev/null || true
          curl -s --max-time 5 https://registry.npmjs.org > /dev/null || true
          curl -s --max-time 5 https://api.github.com > /dev/null || true
          sleep 2

      - name: Verify Iteration 1 Status
        if: steps.iteration-1.outcome == 'success'
        run: |
          echo "=== Iteration 1 Verification ==="
          echo "Expected: Initial whitelist created (listen-only mode)"
          echo "Status should be: created"
          echo "Stable should be: false"

  # Iteration 2: First augmentation (should add new endpoints)
  auto-whitelist-iteration-2:
    timeout-minutes: 30
    needs: auto-whitelist-iteration-1
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download artifact from previous iteration
        uses: actions/download-artifact@v4
        with:
          name: test-complex-auto-whitelist-${{ runner.os }}
          path: ~/
          github-token: ${{ github.token }}
        continue-on-error: true

      - name: Verify artifact download
        run: |
          if [[ -f ~/auto_whitelist.json ]]; then
            echo "✅ Artifact downloaded successfully"
            echo "Iteration: $(cat ~/auto_whitelist_iteration.txt 2>/dev/null || echo 'unknown')"
            echo "Stable count: $(cat ~/auto_whitelist_stable_count.txt 2>/dev/null || echo '0')"
          else
            echo "⚠️  No artifact found (this might be expected for iteration 2)"
          fi

      - name: Setup EDAMAME Posture - Iteration 2
        id: iteration-2
        uses: ./
        with:
          disconnected_mode: true
          network_scan: true
          packet_capture: true
          auto_whitelist: true
          auto_whitelist_artifact_name: test-complex-auto-whitelist-${{ runner.os }}
          auto_whitelist_stability_threshold: "0"
          auto_whitelist_stability_consecutive_runs: "3"
          auto_whitelist_max_iterations: "10"
          dump_sessions_log: true
          display_logs: false
        continue-on-error: true

      - name: Simulate Network Traffic - Iteration 2
        if: steps.iteration-2.outcome == 'success'
        run: |
          echo "Simulating iteration 2 network traffic patterns..."
          # Same connections as iteration 1 (should be stable)
          curl -s --max-time 5 https://www.github.com > /dev/null || true
          curl -s --max-time 5 https://registry.npmjs.org > /dev/null || true
          curl -s --max-time 5 https://api.github.com > /dev/null || true
          # Add NEW connections (should cause augmentation)
          curl -s --max-time 5 https://www.npmjs.com > /dev/null || true
          curl -s --max-time 5 https://cdn.jsdelivr.net > /dev/null || true
          sleep 2

      - name: Verify Iteration 2 Status
        if: steps.iteration-2.outcome == 'success'
        run: |
          echo "=== Iteration 2 Verification ==="
          echo "Expected: Whitelist augmented with new endpoints"
          echo "Status should be: evolving"
          echo "Difference should be: > 0%"
          echo "Stable count should reset to: 0"

  # Iteration 3: More augmentation (different endpoints)
  auto-whitelist-iteration-3:
    timeout-minutes: 30
    needs: auto-whitelist-iteration-2
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download artifact from previous iteration
        uses: actions/download-artifact@v4
        with:
          name: test-complex-auto-whitelist-${{ runner.os }}
          path: ~/
          github-token: ${{ github.token }}

      - name: Setup EDAMAME Posture - Iteration 3
        id: iteration-3
        uses: ./
        with:
          disconnected_mode: true
          network_scan: true
          packet_capture: true
          auto_whitelist: true
          auto_whitelist_artifact_name: test-complex-auto-whitelist-${{ runner.os }}
          auto_whitelist_stability_threshold: "0"
          auto_whitelist_stability_consecutive_runs: "3"
          auto_whitelist_max_iterations: "10"
          dump_sessions_log: true
          display_logs: false
        continue-on-error: true

      - name: Simulate Network Traffic - Iteration 3
        if: steps.iteration-3.outcome == 'success'
        run: |
          echo "Simulating iteration 3 network traffic patterns..."
          # All previous connections
          curl -s --max-time 5 https://www.github.com > /dev/null || true
          curl -s --max-time 5 https://registry.npmjs.org > /dev/null || true
          curl -s --max-time 5 https://api.github.com > /dev/null || true
          curl -s --max-time 5 https://www.npmjs.com > /dev/null || true
          curl -s --max-time 5 https://cdn.jsdelivr.net > /dev/null || true
          # Add MORE new connections
          curl -s --max-time 5 https://fonts.googleapis.com > /dev/null || true
          curl -s --max-time 5 https://www.google-analytics.com > /dev/null || true
          sleep 2

      - name: Verify Iteration 3 Status
        if: steps.iteration-3.outcome == 'success'
        run: |
          echo "=== Iteration 3 Verification ==="
          echo "Expected: Whitelist further augmented"
          echo "Status should be: evolving"
          echo "Difference should be: > 0%"
          echo "Stable count should reset to: 0"

  # Iteration 4: Stable run (no new endpoints)
  auto-whitelist-iteration-4:
    timeout-minutes: 30
    needs: auto-whitelist-iteration-3
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download artifact from previous iteration
        uses: actions/download-artifact@v4
        with:
          name: test-complex-auto-whitelist-${{ runner.os }}
          path: ~/
          github-token: ${{ github.token }}

      - name: Setup EDAMAME Posture - Iteration 4
        id: iteration-4
        uses: ./
        with:
          disconnected_mode: true
          network_scan: true
          packet_capture: true
          auto_whitelist: true
          auto_whitelist_artifact_name: test-complex-auto-whitelist-${{ runner.os }}
          auto_whitelist_stability_threshold: "0"
          auto_whitelist_stability_consecutive_runs: "3"
          auto_whitelist_max_iterations: "10"
          dump_sessions_log: true
          display_logs: false
        continue-on-error: true

      - name: Simulate Network Traffic - Iteration 4 (Stable)
        if: steps.iteration-4.outcome == 'success'
        run: |
          echo "Simulating iteration 4 network traffic patterns (STABLE - no new endpoints)..."
          # Only use connections that were already whitelisted
          curl -s --max-time 5 https://www.github.com > /dev/null || true
          curl -s --max-time 5 https://registry.npmjs.org > /dev/null || true
          curl -s --max-time 5 https://api.github.com > /dev/null || true
          curl -s --max-time 5 https://www.npmjs.com > /dev/null || true
          curl -s --max-time 5 https://cdn.jsdelivr.net > /dev/null || true
          curl -s --max-time 5 https://fonts.googleapis.com > /dev/null || true
          curl -s --max-time 5 https://www.google-analytics.com > /dev/null || true
          sleep 2

      - name: Verify Iteration 4 Status
        if: steps.iteration-4.outcome == 'success'
        run: |
          echo "=== Iteration 4 Verification ==="
          echo "Expected: First stable run (0% difference)"
          echo "Status should be: stable"
          echo "Difference should be: 0%"
          echo "Stable count should be: 1 / 3"

  # Iteration 5: Second stable run
  auto-whitelist-iteration-5:
    timeout-minutes: 30
    needs: auto-whitelist-iteration-4
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download artifact from previous iteration
        uses: actions/download-artifact@v4
        with:
          name: test-complex-auto-whitelist-${{ runner.os }}
          path: ~/
          github-token: ${{ github.token }}

      - name: Setup EDAMAME Posture - Iteration 5
        id: iteration-5
        uses: ./
        with:
          disconnected_mode: true
          network_scan: true
          packet_capture: true
          auto_whitelist: true
          auto_whitelist_artifact_name: test-complex-auto-whitelist-${{ runner.os }}
          auto_whitelist_stability_threshold: "0"
          auto_whitelist_stability_consecutive_runs: "3"
          auto_whitelist_max_iterations: "10"
          dump_sessions_log: true
          display_logs: false
        continue-on-error: true

      - name: Simulate Network Traffic - Iteration 5 (Stable)
        if: steps.iteration-5.outcome == 'success'
        run: |
          echo "Simulating iteration 5 network traffic patterns (STABLE - no new endpoints)..."
          # Same connections as iteration 4
          curl -s --max-time 5 https://www.github.com > /dev/null || true
          curl -s --max-time 5 https://registry.npmjs.org > /dev/null || true
          curl -s --max-time 5 https://api.github.com > /dev/null || true
          curl -s --max-time 5 https://www.npmjs.com > /dev/null || true
          curl -s --max-time 5 https://cdn.jsdelivr.net > /dev/null || true
          curl -s --max-time 5 https://fonts.googleapis.com > /dev/null || true
          curl -s --max-time 5 https://www.google-analytics.com > /dev/null || true
          sleep 2

      - name: Verify Iteration 5 Status
        if: steps.iteration-5.outcome == 'success'
        run: |
          echo "=== Iteration 5 Verification ==="
          echo "Expected: Second stable run (0% difference)"
          echo "Status should be: stable"
          echo "Difference should be: 0%"
          echo "Stable count should be: 2 / 3"

  # Iteration 6: Third stable run (should trigger enforcement)
  auto-whitelist-iteration-6:
    timeout-minutes: 30
    needs: auto-whitelist-iteration-5
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download artifact from previous iteration
        uses: actions/download-artifact@v4
        with:
          name: test-complex-auto-whitelist-${{ runner.os }}
          path: ~/
          github-token: ${{ github.token }}

      - name: Setup EDAMAME Posture - Iteration 6
        id: iteration-6
        uses: ./
        with:
          disconnected_mode: true
          network_scan: true
          packet_capture: true
          auto_whitelist: true
          auto_whitelist_artifact_name: test-complex-auto-whitelist-${{ runner.os }}
          auto_whitelist_stability_threshold: "0"
          auto_whitelist_stability_consecutive_runs: "3"
          auto_whitelist_max_iterations: "10"
          dump_sessions_log: true
          display_logs: false
        continue-on-error: true

      - name: Simulate Network Traffic - Iteration 6 (Stable)
        if: steps.iteration-6.outcome == 'success'
        run: |
          echo "Simulating iteration 6 network traffic patterns (STABLE - no new endpoints)..."
          # Same connections as previous stable runs
          curl -s --max-time 5 https://www.github.com > /dev/null || true
          curl -s --max-time 5 https://registry.npmjs.org > /dev/null || true
          curl -s --max-time 5 https://api.github.com > /dev/null || true
          curl -s --max-time 5 https://www.npmjs.com > /dev/null || true
          curl -s --max-time 5 https://cdn.jsdelivr.net > /dev/null || true
          curl -s --max-time 5 https://fonts.googleapis.com > /dev/null || true
          curl -s --max-time 5 https://www.google-analytics.com > /dev/null || true
          sleep 2

      - name: Verify Iteration 6 Status
        if: steps.iteration-6.outcome == 'success'
        run: |
          echo "=== Iteration 6 Verification ==="
          echo "Expected: Third stable run - WHITELIST SHOULD BE FULLY STABLE"
          echo "Status should be: stable"
          echo "Difference should be: 0%"
          echo "Stable count should be: 3 / 3"
          echo "Enforcement mode should be: ACTIVE"

  # Iteration 7: Enforcement mode test (should allow whitelisted traffic)
  auto-whitelist-iteration-7-enforcement-pass:
    timeout-minutes: 30
    needs: auto-whitelist-iteration-6
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download artifact from previous iteration
        uses: actions/download-artifact@v4
        with:
          name: test-complex-auto-whitelist-${{ runner.os }}
          path: ~/
          github-token: ${{ github.token }}

      - name: Setup EDAMAME Posture - Iteration 7 (Enforcement Pass)
        id: iteration-7-pass
        uses: ./
        with:
          disconnected_mode: true
          network_scan: true
          packet_capture: true
          auto_whitelist: true
          auto_whitelist_artifact_name: test-complex-auto-whitelist-${{ runner.os }}
          auto_whitelist_stability_threshold: "0"
          auto_whitelist_stability_consecutive_runs: "3"
          auto_whitelist_max_iterations: "10"
          dump_sessions_log: true
          exit_on_whitelist_exceptions: true
          display_logs: false
        continue-on-error: true

      - name: Simulate Network Traffic - Iteration 7 (Only Whitelisted)
        if: steps.iteration-7-pass.outcome == 'success'
        run: |
          echo "Simulating iteration 7 network traffic patterns (ENFORCEMENT MODE - only whitelisted endpoints)..."
          # Only use endpoints that are already in the whitelist
          curl -s --max-time 5 https://www.github.com > /dev/null || true
          curl -s --max-time 5 https://registry.npmjs.org > /dev/null || true
          curl -s --max-time 5 https://api.github.com > /dev/null || true
          curl -s --max-time 5 https://www.npmjs.com > /dev/null || true
          curl -s --max-time 5 https://cdn.jsdelivr.net > /dev/null || true
          curl -s --max-time 5 https://fonts.googleapis.com > /dev/null || true
          curl -s --max-time 5 https://www.google-analytics.com > /dev/null || true
          sleep 2

      - name: Verify Iteration 7 Pass Status
        if: steps.iteration-7-pass.outcome == 'success'
        run: |
          echo "=== Iteration 7 Verification (Enforcement Pass) ==="
          echo "Expected: All traffic conforms to whitelist"
          echo "Exit code should be: 0 (success)"
          echo "No whitelist exceptions should be detected"

  # Iteration 8: Enforcement mode test (should fail on unauthorized traffic)
  auto-whitelist-iteration-8-enforcement-fail:
    timeout-minutes: 30
    needs: auto-whitelist-iteration-7-enforcement-pass
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download artifact from previous iteration
        uses: actions/download-artifact@v4
        with:
          name: test-complex-auto-whitelist-${{ runner.os }}
          path: ~/
          github-token: ${{ github.token }}

      - name: Setup EDAMAME Posture - Iteration 8 (Enforcement Fail)
        id: iteration-8-fail
        uses: ./
        with:
          disconnected_mode: true
          network_scan: true
          packet_capture: true
          auto_whitelist: true
          auto_whitelist_artifact_name: test-complex-auto-whitelist-${{ runner.os }}
          auto_whitelist_stability_threshold: "0"
          auto_whitelist_stability_consecutive_runs: "3"
          auto_whitelist_max_iterations: "10"
          dump_sessions_log: true
          exit_on_whitelist_exceptions: true
          display_logs: false
        continue-on-error: true

      - name: Simulate Network Traffic - Iteration 8 (Unauthorized)
        if: steps.iteration-8-fail.outcome != 'failure'
        run: |
          echo "Simulating iteration 8 network traffic patterns (ENFORCEMENT MODE - includes unauthorized endpoint)..."
          # Some whitelisted endpoints
          curl -s --max-time 5 https://www.github.com > /dev/null || true
          curl -s --max-time 5 https://registry.npmjs.org > /dev/null || true
          # Add UNAUTHORIZED endpoint (not in whitelist)
          curl -s --max-time 5 https://www.example.com > /dev/null || true
          curl -s --max-time 5 https://httpbin.org > /dev/null || true
          sleep 2

      - name: Verify Iteration 8 Fail Status
        run: |
          echo "=== Iteration 8 Verification (Enforcement Fail) ==="
          if [[ "${{ steps.iteration-8-fail.outcome }}" == "failure" ]]; then
            echo "✅ EXPECTED: Workflow failed due to whitelist violations"
            echo "Exit code was non-zero (as expected)"
            echo "Unauthorized endpoints were detected and blocked"
          else
            echo "⚠️  UNEXPECTED: Workflow did not fail"
            echo "This might indicate enforcement is not working correctly"
            echo "Or the unauthorized endpoints were not detected"
          fi

  # Final summary job
  test-summary:
    timeout-minutes: 5
    needs: 
      - auto-whitelist-iteration-1
      - auto-whitelist-iteration-2
      - auto-whitelist-iteration-3
      - auto-whitelist-iteration-4
      - auto-whitelist-iteration-5
      - auto-whitelist-iteration-6
      - auto-whitelist-iteration-7-enforcement-pass
      - auto-whitelist-iteration-8-enforcement-fail
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Test Results Summary
        run: |
          echo "## Auto-Whitelist Complex Test Results"
          echo ""
          echo "### Iteration Results:"
          echo "- Iteration 1 (Initial): ${{ needs.auto-whitelist-iteration-1.result }}"
          echo "- Iteration 2 (Augment): ${{ needs.auto-whitelist-iteration-2.result }}"
          echo "- Iteration 3 (Augment): ${{ needs.auto-whitelist-iteration-3.result }}"
          echo "- Iteration 4 (Stable 1): ${{ needs.auto-whitelist-iteration-4.result }}"
          echo "- Iteration 5 (Stable 2): ${{ needs.auto-whitelist-iteration-5.result }}"
          echo "- Iteration 6 (Stable 3): ${{ needs.auto-whitelist-iteration-6.result }}"
          echo "- Iteration 7 (Enforcement Pass): ${{ needs.auto-whitelist-iteration-7-enforcement-pass.result }}"
          echo "- Iteration 8 (Enforcement Fail): ${{ needs.auto-whitelist-iteration-8-enforcement-fail.result }}"
          echo ""
          echo "### Expected Behavior:"
          echo "1. ✅ Iteration 1: Creates initial whitelist (listen-only)"
          echo "2. ✅ Iteration 2-3: Augments whitelist with new endpoints"
          echo "3. ✅ Iteration 4-6: Three consecutive stable runs (0% change)"
          echo "4. ✅ Iteration 7: Enforcement mode allows whitelisted traffic"
          echo "5. ✅ Iteration 8: Enforcement mode blocks unauthorized traffic"
          echo ""
          
          # Determine overall test status
          if [[ "${{ needs.auto-whitelist-iteration-1.result }}" != "success" ]] || \
             [[ "${{ needs.auto-whitelist-iteration-2.result }}" != "success" ]] || \
             [[ "${{ needs.auto-whitelist-iteration-3.result }}" != "success" ]] || \
             [[ "${{ needs.auto-whitelist-iteration-4.result }}" != "success" ]] || \
             [[ "${{ needs.auto-whitelist-iteration-5.result }}" != "success" ]] || \
             [[ "${{ needs.auto-whitelist-iteration-6.result }}" != "success" ]] || \
             [[ "${{ needs.auto-whitelist-iteration-7-enforcement-pass.result }}" != "success" ]] || \
             [[ "${{ needs.auto-whitelist-iteration-8-enforcement-fail.result }}" != "failure" ]]; then
            echo "❌ Some test iterations did not behave as expected"
            exit 1
          else
            echo "✅ All test iterations completed as expected!"
          fi

      - name: Slack alerts
        if: |
          needs.auto-whitelist-iteration-1.result != 'success' || 
          needs.auto-whitelist-iteration-2.result != 'success' || 
          needs.auto-whitelist-iteration-3.result != 'success' || 
          needs.auto-whitelist-iteration-4.result != 'success' || 
          needs.auto-whitelist-iteration-5.result != 'success' || 
          needs.auto-whitelist-iteration-6.result != 'success' || 
          needs.auto-whitelist-iteration-7-enforcement-pass.result != 'success' || 
          needs.auto-whitelist-iteration-8-enforcement-fail.result != 'failure'
        uses: slackapi/slack-github-action@v1.26.0
        with:
          channel-id: 'C072J0U9TH7'
          slack-message: |
            *Auto-Whitelist Complex Test Results for ${{ github.repository }}*:
            - Iteration 1 (Initial): ${{ needs.auto-whitelist-iteration-1.result == 'success' && '✅ Success' || '❌ Failed' }}
            - Iteration 2 (Augment): ${{ needs.auto-whitelist-iteration-2.result == 'success' && '✅ Success' || '❌ Failed' }}
            - Iteration 3 (Augment): ${{ needs.auto-whitelist-iteration-3.result == 'success' && '✅ Success' || '❌ Failed' }}
            - Iteration 4 (Stable 1): ${{ needs.auto-whitelist-iteration-4.result == 'success' && '✅ Success' || '❌ Failed' }}
            - Iteration 5 (Stable 2): ${{ needs.auto-whitelist-iteration-5.result == 'success' && '✅ Success' || '❌ Failed' }}
            - Iteration 6 (Stable 3): ${{ needs.auto-whitelist-iteration-6.result == 'success' && '✅ Success' || '❌ Failed' }}
            - Iteration 7 (Enforcement Pass): ${{ needs.auto-whitelist-iteration-7-enforcement-pass.result == 'success' && '✅ Success' || '❌ Failed' }}
            - Iteration 8 (Enforcement Fail): ${{ needs.auto-whitelist-iteration-8-enforcement-fail.result == 'failure' && '✅ Success (failed as expected)' || '❌ Unexpected' }}
            Branch: ${{ github.ref }}
            More details: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}

      - name: Fail job if tests failed
        if: |
          needs.auto-whitelist-iteration-1.result != 'success' || 
          needs.auto-whitelist-iteration-2.result != 'success' || 
          needs.auto-whitelist-iteration-3.result != 'success' || 
          needs.auto-whitelist-iteration-4.result != 'success' || 
          needs.auto-whitelist-iteration-5.result != 'success' || 
          needs.auto-whitelist-iteration-6.result != 'success' || 
          needs.auto-whitelist-iteration-7-enforcement-pass.result != 'success' || 
          needs.auto-whitelist-iteration-8-enforcement-fail.result != 'failure'
        run: |
          echo "## Test Results Summary"
          echo "Some test iterations did not behave as expected."
          echo ""
          echo "Forcing job to fail because tests did not succeed."
          exit 1

