name: Test Auto-Whitelist Lifecycle

# This workflow tests the complete auto-whitelist lifecycle including:
# 1. Learning phase: Generate baseline whitelist from legitimate traffic
# 2. Augmentation phase: Add new endpoints to existing whitelist
# 3. Enforcement phase (pass): Verify authorized traffic is allowed
# 4. Enforcement phase (fail): Detect violations when unauthorized traffic occurs
# 5. Artifact persistence: Upload/download whitelist across workflow runs
#
# Important notes:
# - Uses include_local_traffic: false to avoid capturing localhost/runner system traffic
# - Uses 30s waits to let background GitHub runner traffic settle before our test traffic
# - Uses specific, stable URLs (e.g., /zen, /robots.txt) for consistent endpoint capture

on:
  workflow_dispatch:
    inputs:
      cleanup_artifacts:
        description: 'Delete existing whitelist artifacts before running'
        required: false
        default: false
        type: boolean
  push:
    branches:
      - 'dev'
      - 'main'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  actions: write

jobs:
  # Phase 1: Learning - Generate baseline whitelist
  learning-phase:
    name: Learning Phase - Generate Baseline Whitelist
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Clean up existing artifacts (optional)
        if: github.event_name == 'workflow_dispatch' && inputs.cleanup_artifacts == true
        env:
          GH_TOKEN: ${{ github.token }}
        continue-on-error: true
        run: |
          echo "Cleaning up existing auto-whitelist artifacts..."
          ARTIFACT_NAME="test-auto-whitelist-${{ github.run_id }}"
          ARTIFACT_IDS=$(gh api repos/${{ github.repository }}/actions/artifacts --paginate --jq ".artifacts[] | select(.name | startswith(\"test-auto-whitelist-\")) | .id" 2>/dev/null || true)
          if [[ -n "$ARTIFACT_IDS" ]]; then
            echo "$ARTIFACT_IDS" | while read -r ARTIFACT_ID; do
              [[ -n "$ARTIFACT_ID" ]] || continue
              echo "Deleting artifact id $ARTIFACT_ID"
              gh api repos/${{ github.repository }}/actions/artifacts/$ARTIFACT_ID -X DELETE 2>/dev/null || echo "Failed to delete (may already be expired)"
            done
          else
            echo "No existing artifacts found"
          fi

      - name: Start EDAMAME Posture in disconnected mode
        id: start-edamame
        uses: ./
        with:
          disconnected_mode: true
          network_scan: true
          packet_capture: true
          whitelist: github_ubuntu
          include_local_traffic: false
          display_logs: false

      - name: Wait for capture readiness and let background traffic settle
        run: |
          echo "Waiting for EDAMAME Posture to be ready and background traffic to settle..."
          sleep 30

      - name: Generate legitimate baseline traffic
        run: |
          echo "Generating baseline traffic for whitelist learning..."
          
          # Simulate typical CI/CD traffic - use specific, predictable endpoints
          curl -s --max-time 10 https://api.github.com/zen > /dev/null || true
          curl -s --max-time 10 https://github.com/robots.txt > /dev/null || true
          curl -s --max-time 10 https://registry.npmjs.org/-/ping > /dev/null || true
          
          # Wait for traffic to be captured
          echo "Waiting for traffic capture..."
          sleep 30

      - name: Create custom whitelist from captured traffic
        id: create-whitelist
        uses: ./
        with:
          create_custom_whitelists: true
          custom_whitelists_path: ${{ github.workspace }}/baseline_whitelist.json
          display_logs: true

      - name: Stop EDAMAME Posture
        uses: ./
        with:
          stop: true
        continue-on-error: true

      - name: Validate baseline whitelist is not empty
        run: |
          echo "Validating baseline whitelist..."
          
          if [[ ! -f "${{ github.workspace }}/baseline_whitelist.json" ]]; then
            echo "❌ ERROR: baseline_whitelist.json was not created" >&2
            exit 1
          fi
          
          if [[ ! -s "${{ github.workspace }}/baseline_whitelist.json" ]]; then
            echo "❌ ERROR: baseline_whitelist.json is empty" >&2
            exit 1
          fi
          
          # Check if it's valid JSON
          if ! jq empty "${{ github.workspace }}/baseline_whitelist.json" 2>/dev/null; then
            echo "❌ ERROR: baseline_whitelist.json is not valid JSON" >&2
            cat "${{ github.workspace }}/baseline_whitelist.json"
            exit 1
          fi
          
          # Count endpoints
          ENDPOINT_COUNT=$(jq '[.whitelists[].endpoints | length] | add // 0' "${{ github.workspace }}/baseline_whitelist.json" 2>/dev/null || echo '0')
          echo "✅ Baseline whitelist contains $ENDPOINT_COUNT endpoints"
          
          if [[ "$ENDPOINT_COUNT" -eq 0 ]]; then
            echo "❌ ERROR: Whitelist contains no endpoints" >&2
            cat "${{ github.workspace }}/baseline_whitelist.json"
            exit 1
          fi
          
          # Display whitelist content for debugging
          echo "Baseline whitelist content:"
          jq '.' "${{ github.workspace }}/baseline_whitelist.json"

      - name: Upload baseline whitelist as artifact
        uses: actions/upload-artifact@v4
        with:
          name: test-auto-whitelist-${{ github.run_id }}-baseline
          path: ${{ github.workspace }}/baseline_whitelist.json
          retention-days: 1

  # Phase 2: Augmentation - Add new endpoints to existing whitelist
  augmentation-phase:
    name: Augmentation Phase - Add New Endpoints
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: learning-phase
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download baseline whitelist artifact
        uses: actions/download-artifact@v4
        with:
          name: test-auto-whitelist-${{ github.run_id }}-baseline
          path: ${{ github.workspace }}

      - name: Verify downloaded whitelist
        run: |
          echo "Verifying downloaded baseline whitelist..."
          
          if [[ ! -f "${{ github.workspace }}/baseline_whitelist.json" ]]; then
            echo "❌ ERROR: Failed to download baseline_whitelist.json" >&2
            exit 1
          fi
          
          BASELINE_COUNT=$(jq '[.whitelists[].endpoints | length] | add // 0' "${{ github.workspace }}/baseline_whitelist.json")
          echo "✅ Downloaded baseline whitelist with $BASELINE_COUNT endpoints"

      - name: Start EDAMAME Posture
        uses: ./
        with:
          disconnected_mode: true
          network_scan: true
          packet_capture: true
          whitelist: github_ubuntu
          include_local_traffic: false
          display_logs: false

      - name: Wait for capture readiness and let background traffic settle
        run: |
          echo "Waiting for EDAMAME Posture to be ready and background traffic to settle..."
          sleep 30

      - name: Generate additional traffic (new endpoints)
        run: |
          echo "Generating traffic with new endpoints..."
          
          # Replay baseline traffic
          curl -s --max-time 10 https://api.github.com/zen > /dev/null || true
          curl -s --max-time 10 https://github.com/robots.txt > /dev/null || true
          curl -s --max-time 10 https://registry.npmjs.org/-/ping > /dev/null || true
          
          # Add new endpoints that weren't in baseline
          curl -s --max-time 10 https://www.npmjs.com/ > /dev/null || true
          curl -s --max-time 10 https://cdn.jsdelivr.net/npm/ > /dev/null || true
          
          echo "Waiting for traffic capture..."
          sleep 30

      - name: Augment whitelist with new endpoints
        uses: ./
        with:
          augment_custom_whitelists: true
          custom_whitelists_path: ${{ github.workspace }}/baseline_whitelist.json
          display_logs: true

      - name: Stop EDAMAME Posture
        uses: ./
        with:
          stop: true
        continue-on-error: true

      - name: Validate augmented whitelist
        run: |
          echo "Validating augmented whitelist..."
          
          if [[ ! -f "${{ github.workspace }}/baseline_whitelist.json" ]]; then
            echo "❌ ERROR: Augmented whitelist not found" >&2
            exit 1
          fi
          
          AUGMENTED_COUNT=$(jq '[.whitelists[].endpoints | length] | add // 0' "${{ github.workspace }}/baseline_whitelist.json")
          echo "✅ Augmented whitelist contains $AUGMENTED_COUNT endpoints"
          
          # Display augmented whitelist
          echo "Augmented whitelist content:"
          jq '.' "${{ github.workspace }}/baseline_whitelist.json"

      - name: Rename for upload
        run: |
          cp "${{ github.workspace }}/baseline_whitelist.json" "${{ github.workspace }}/augmented_whitelist.json"

      - name: Upload augmented whitelist as artifact
        uses: actions/upload-artifact@v4
        with:
          name: test-auto-whitelist-${{ github.run_id }}-augmented
          path: ${{ github.workspace }}/augmented_whitelist.json
          retention-days: 1

  # Phase 3: Enforcement - Verify whitelist detects violations
  enforcement-phase-pass:
    name: Enforcement Phase - Authorized Traffic (Pass)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: augmentation-phase
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download augmented whitelist artifact
        uses: actions/download-artifact@v4
        with:
          name: test-auto-whitelist-${{ github.run_id }}-augmented
          path: ${{ github.workspace }}

      - name: Verify downloaded whitelist
        run: |
          echo "Verifying downloaded augmented whitelist..."
          
          if [[ ! -f "${{ github.workspace }}/augmented_whitelist.json" ]]; then
            echo "❌ ERROR: Failed to download augmented_whitelist.json" >&2
            exit 1
          fi
          
          COUNT=$(jq '[.whitelists[].endpoints | length] | add // 0' "${{ github.workspace }}/augmented_whitelist.json")
          echo "✅ Downloaded augmented whitelist with $COUNT endpoints"

      - name: Start EDAMAME Posture with enforcement
        uses: ./
        with:
          disconnected_mode: true
          network_scan: true
          packet_capture: true
          custom_whitelists_path: ${{ github.workspace }}/augmented_whitelist.json
          set_custom_whitelists: true
          include_local_traffic: false
          display_logs: false

      - name: Wait for capture readiness and let background traffic settle
        run: |
          echo "Waiting for EDAMAME Posture to be ready and background traffic to settle..."
          sleep 30

      - name: Generate only authorized traffic
        run: |
          echo "Generating only whitelisted traffic (should pass)..."
          
          # Only use endpoints that are in the augmented whitelist - exact same URLs as learning/augmentation
          curl -s --max-time 10 https://api.github.com/zen > /dev/null || true
          curl -s --max-time 10 https://github.com/robots.txt > /dev/null || true
          curl -s --max-time 10 https://registry.npmjs.org/-/ping > /dev/null || true
          curl -s --max-time 10 https://www.npmjs.com/ > /dev/null || true
          curl -s --max-time 10 https://cdn.jsdelivr.net/npm/ > /dev/null || true
          
          echo "Waiting for traffic analysis..."
          sleep 30

      - name: Check for whitelist violations (should pass)
        id: check-violations-pass
        uses: ./
        with:
          dump_sessions_log: true
          exit_on_whitelist_exceptions: true
          display_logs: true

      - name: Stop EDAMAME Posture
        uses: ./
        with:
          stop: true
        continue-on-error: true

      - name: Verify enforcement passed
        run: |
          echo "✅ SUCCESS: Authorized traffic passed whitelist enforcement"

  # Phase 4: Enforcement - Detect violations
  enforcement-phase-fail:
    name: Enforcement Phase - Unauthorized Traffic (Fail Expected)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: augmentation-phase
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download augmented whitelist artifact
        uses: actions/download-artifact@v4
        with:
          name: test-auto-whitelist-${{ github.run_id }}-augmented
          path: ${{ github.workspace }}

      - name: Start EDAMAME Posture with enforcement
        uses: ./
        with:
          disconnected_mode: true
          network_scan: true
          packet_capture: true
          custom_whitelists_path: ${{ github.workspace }}/augmented_whitelist.json
          set_custom_whitelists: true
          include_local_traffic: false
          display_logs: false

      - name: Wait for capture readiness and let background traffic settle
        run: |
          echo "Waiting for EDAMAME Posture to be ready and background traffic to settle..."
          sleep 30

      - name: Generate unauthorized traffic
        run: |
          echo "Generating whitelisted + unauthorized traffic (should fail)..."
          
          # Some authorized traffic (same as learning/augmentation)
          curl -s --max-time 10 https://api.github.com/zen > /dev/null || true
          curl -s --max-time 10 https://github.com/robots.txt > /dev/null || true
          
          # UNAUTHORIZED traffic - should trigger violation
          curl -s --max-time 10 https://example.com > /dev/null || true
          curl -s --max-time 10 https://httpbin.org/get > /dev/null || true
          
          echo "Waiting for traffic analysis..."
          sleep 30

      - name: Check for whitelist violations (should fail)
        id: check-violations-fail
        uses: ./
        with:
          dump_sessions_log: true
          exit_on_whitelist_exceptions: true
          display_logs: true
        continue-on-error: true

      - name: Stop EDAMAME Posture
        uses: ./
        with:
          stop: true
        continue-on-error: true

      - name: Verify enforcement detected violations
        env:
          CHECK_OUTCOME: ${{ steps.check-violations-fail.outcome }}
        run: |
          echo "Verification outcome: $CHECK_OUTCOME"
          
          if [[ "$CHECK_OUTCOME" == "failure" ]]; then
            echo "✅ SUCCESS: Whitelist enforcement correctly detected unauthorized traffic"
            exit 0
          else
            echo "❌ FAILURE: Whitelist enforcement failed to detect unauthorized traffic"
            exit 1
          fi

  # Final validation job
  validate-complete-lifecycle:
    name: Validate Complete Lifecycle
    runs-on: ubuntu-latest
    needs: [learning-phase, augmentation-phase, enforcement-phase-pass, enforcement-phase-fail]
    if: always()
    steps:
      - name: Check all phases completed successfully
        env:
          LEARNING_RESULT: ${{ needs.learning-phase.result }}
          AUGMENTATION_RESULT: ${{ needs.augmentation-phase.result }}
          ENFORCEMENT_PASS_RESULT: ${{ needs.enforcement-phase-pass.result }}
          ENFORCEMENT_FAIL_RESULT: ${{ needs.enforcement-phase-fail.result }}
        run: |
          echo "=== Auto-Whitelist Lifecycle Test Results ==="
          echo "Learning Phase:            $LEARNING_RESULT"
          echo "Augmentation Phase:        $AUGMENTATION_RESULT"
          echo "Enforcement (Pass):        $ENFORCEMENT_PASS_RESULT"
          echo "Enforcement (Fail):        $ENFORCEMENT_FAIL_RESULT"
          echo "=============================================="
          
          FAILED=false
          
          if [[ "$LEARNING_RESULT" != "success" ]]; then
            echo "❌ Learning phase failed"
            FAILED=true
          fi
          
          if [[ "$AUGMENTATION_RESULT" != "success" ]]; then
            echo "❌ Augmentation phase failed"
            FAILED=true
          fi
          
          if [[ "$ENFORCEMENT_PASS_RESULT" != "success" ]]; then
            echo "❌ Enforcement phase (authorized traffic) failed"
            FAILED=true
          fi
          
          if [[ "$ENFORCEMENT_FAIL_RESULT" != "success" ]]; then
            echo "❌ Enforcement phase (unauthorized traffic) failed"
            FAILED=true
          fi
          
          if [[ "$FAILED" == "true" ]]; then
            echo ""
            echo "❌ OVERALL: Auto-whitelist lifecycle test FAILED"
            exit 1
          else
            echo ""
            echo "✅ OVERALL: Auto-whitelist lifecycle test PASSED"
            echo "All phases completed successfully:"
            echo "  ✅ Whitelist creation from traffic"
            echo "  ✅ Artifact upload/download"
            echo "  ✅ Whitelist augmentation"
            echo "  ✅ Enforcement with authorized traffic"
            echo "  ✅ Violation detection with unauthorized traffic"
          fi

      - name: Send Slack notification on failure
        if: failure()
        uses: slackapi/slack-github-action@v1.26.0
        with:
          channel-id: 'C072J0U9TH7'
          slack-message: |
            ❌ Auto-Whitelist Lifecycle Test Failed
            Repository: ${{ github.repository }}
            Branch: ${{ github.ref }}
            Run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            Phase Results:
            - Learning: ${{ needs.learning-phase.result }}
            - Augmentation: ${{ needs.augmentation-phase.result }}
            - Enforcement (Pass): ${{ needs.enforcement-phase-pass.result }}
            - Enforcement (Fail): ${{ needs.enforcement-phase-fail.result }}
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
        continue-on-error: true
