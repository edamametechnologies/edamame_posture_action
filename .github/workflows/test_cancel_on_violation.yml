name: Test Cancel on Violation

# This workflow tests the cancel_on_violation feature:
# Tests that violations trigger cancellation in both connected and disconnected modes
# Expected: Workflow should be cancelled when violations are detected

on:
  workflow_dispatch:
  push:
    branches:
        - 'dev'
        - 'main'
          
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false  # Allow sequential runs for testing

permissions:
  contents: read
  actions: write

jobs:
  # Test cancellation in connected mode
  test-cancellation-connected:
    name: Test Cancellation (Connected Mode)
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup EDAMAME Posture with cancel_on_violation
        uses: ./
        with:
          edamame_user: ${{ vars.EDAMAME_POSTURE_USER }}
          edamame_domain: ${{ vars.EDAMAME_POSTURE_DOMAIN }}
          edamame_pin: ${{ secrets.EDAMAME_POSTURE_PIN }}
          edamame_id: ${{ github.run_id }}_cancel_test_connected
          network_scan: true
          packet_capture: true
          whitelist: github_ubuntu
          check_whitelist: true
          cancel_on_violation: true
          display_logs: true

      - name: Debug - Check cancellation script and CI/CD detection
        run: |
          echo "=== CI Environment Variables ==="
          echo "CI=$CI"
          echo "GITHUB_ACTIONS=$GITHUB_ACTIONS"
          echo "GITHUB_RUN_ID=$GITHUB_RUN_ID"
          echo "HOME=$HOME"
          echo ""
          echo "=== Checking cancellation script location ==="
          ls -la "$HOME/cancel_pipeline.sh" 2>&1 || echo "NOT FOUND at $HOME/cancel_pipeline.sh"
          echo ""
          echo "=== Script contents (if exists) ==="
          cat "$HOME/cancel_pipeline.sh" 2>/dev/null || echo "Cannot read $HOME/cancel_pipeline.sh"
          echo ""
          echo "=== Daemon status ==="
          $EDAMAME_POSTURE_CMD status || echo "Daemon not responding"
          echo ""
          echo "=== Checking if daemon sees CI/CD environment ==="
          $EDAMAME_POSTURE_CMD logs 2>&1 | grep -iE "CI/CD|cancel|environment" | head -20 || echo "No CI/CD related logs yet"

      - name: Generate Violation (Unauthorized Connection)
        run: |
          echo "Waiting 60 seconds for daemon to stabilize..."
          sleep 60

          echo "Generating unauthorized network connection to trigger cancellation..."
          echo "This should cause the workflow to be cancelled by EDAMAME Posture"
          
          # Make a connection to a domain not in github_ubuntu whitelist
          # This will trigger a whitelist violation
          curl -s --max-time 5 https://example.com > /dev/null || true
          
          # Wait for the violation to be detected by the daemon
          # The daemon checks for violations every 10 seconds, so we need to wait at least 15 seconds
          # to ensure it has time to detect and execute the cancellation
          echo "Waiting for daemon to detect violation and cancel pipeline..."
          for i in {1..10}; do
            # Dump sessions log
            $EDAMAME_POSTURE_CMD get-sessions || echo "Daemon not responding (may have exited after cancellation attempt)"
            echo "--- Checking daemon logs ---"
            $EDAMAME_POSTURE_CMD logs 2>&1 | tail -50 || echo "Cannot get logs"
            sleep 20
          done

          echo "[WARNING] If you see this message, cancellation may not have worked"
          echo "Expected: Workflow should be cancelled before reaching this point"

      - name: Verify Cancellation Result
        if: always()
        run: |
          # Give filesystem a moment to sync after cancellation
          sleep 2
          sync 2>/dev/null || true
          
          echo "=== Cancellation Script Log ==="
          if [[ -f /tmp/cancel_pipeline.log ]]; then
            cat /tmp/cancel_pipeline.log
            echo ""
            # Check if cancellation was successful (check for either success message or that gh command was executed)
            if grep -q "\[OK\] Pipeline cancellation command" /tmp/cancel_pipeline.log; then
              echo "[SUCCESS] Cancellation was triggered and executed!"
              exit 0
            elif grep -q "Executing: gh run cancel" /tmp/cancel_pipeline.log; then
              echo "[SUCCESS] Cancellation command was executed (log may be incomplete due to runner shutdown)"
              exit 0
            else
              echo "[WARNING] Cancellation log exists but execution not confirmed"
              exit 1
            fi
          else
            echo "[ERROR] No cancellation log found at /tmp/cancel_pipeline.log"
            echo "Cancellation script may not have been executed"
            # If the job was cancelled, the script likely ran but log wasn't synced
            if [[ "${{ job.status }}" == "cancelled" ]]; then
              echo "[INFO] Job was cancelled - script likely ran but log not synced before shutdown"
              exit 0
            fi
            exit 1
          fi

  # Test cancellation in disconnected mode
  test-cancellation-disconnected:
    name: Test Cancellation (Disconnected Mode)
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup EDAMAME Posture in Disconnected Mode with cancel_on_violation
        uses: ./
        with:
          disconnected_mode: true
          network_scan: true
          packet_capture: true
          whitelist: github_ubuntu
          check_whitelist: true
          cancel_on_violation: true
          display_logs: true

      - name: Debug - Check cancellation script and CI/CD detection
        run: |
          echo "=== CI Environment Variables ==="
          echo "CI=$CI"
          echo "GITHUB_ACTIONS=$GITHUB_ACTIONS"
          echo "GITHUB_RUN_ID=$GITHUB_RUN_ID"
          echo "HOME=$HOME"
          echo ""
          echo "=== Checking cancellation script location ==="
          ls -la "$HOME/cancel_pipeline.sh" 2>&1 || echo "NOT FOUND at $HOME/cancel_pipeline.sh"
          echo ""
          echo "=== Script contents (if exists) ==="
          cat "$HOME/cancel_pipeline.sh" 2>/dev/null || echo "Cannot read $HOME/cancel_pipeline.sh"
          echo ""
          echo "=== Daemon status ==="
          $EDAMAME_POSTURE_CMD status || echo "Daemon not responding"
          echo ""
          echo "=== Checking if daemon sees CI/CD environment ==="
          $EDAMAME_POSTURE_CMD logs 2>&1 | grep -iE "CI/CD|cancel|environment" | head -20 || echo "No CI/CD related logs yet"

      - name: Generate Violation (Unauthorized Connection)
        run: |
          echo "Waiting 60 seconds for daemon to stabilize..."
          sleep 60

          echo "Generating unauthorized network connection to trigger cancellation..."
          echo "This should cause the workflow to be cancelled by EDAMAME Posture"
          
          # Make a connection to a domain not in github_ubuntu whitelist
          curl -s --max-time 5 https://example.com > /dev/null || true
          
          # Wait for the violation to be detected by the daemon
          # The daemon checks for violations every 10 seconds, so we need to wait at least 15 seconds
          # to ensure it has time to detect and execute the cancellation
          echo "Waiting for daemon to detect violation and cancel pipeline..."
          for i in {1..10}; do
            # Dump sessions log
            $EDAMAME_POSTURE_CMD get-sessions || echo "Daemon not responding (may have exited after cancellation attempt)"
            echo "--- Checking daemon logs ---"
            $EDAMAME_POSTURE_CMD logs 2>&1 | tail -50 || echo "Cannot get logs"
            sleep 20
          done

          echo "[WARNING] If you see this message, cancellation may not have worked"
          echo "Expected: Workflow should be cancelled before reaching this point"

      - name: Verify Cancellation Result
        if: always()
        run: |
          # Give filesystem a moment to sync after cancellation
          sleep 2
          sync 2>/dev/null || true
          
          echo "=== Cancellation Script Log ==="
          if [[ -f /tmp/cancel_pipeline.log ]]; then
            cat /tmp/cancel_pipeline.log
            echo ""
            # Check if cancellation was successful (check for either success message or that gh command was executed)
            if grep -q "\[OK\] Pipeline cancellation command" /tmp/cancel_pipeline.log; then
              echo "[SUCCESS] Cancellation was triggered and executed!"
              exit 0
            elif grep -q "Executing: gh run cancel" /tmp/cancel_pipeline.log; then
              echo "[SUCCESS] Cancellation command was executed (log may be incomplete due to runner shutdown)"
              exit 0
            else
              echo "[WARNING] Cancellation log exists but execution not confirmed"
              exit 1
            fi
          else
            echo "[ERROR] No cancellation log found at /tmp/cancel_pipeline.log"
            echo "Cancellation script may not have been executed"
            # If the job was cancelled, the script likely ran but log wasn't synced
            if [[ "${{ job.status }}" == "cancelled" ]]; then
              echo "[INFO] Job was cancelled - script likely ran but log not synced before shutdown"
              exit 0
            fi
            exit 1
          fi

