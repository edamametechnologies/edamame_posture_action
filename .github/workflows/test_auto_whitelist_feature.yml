name: Test Auto-Whitelist Feature

# This workflow tests the auto_whitelist feature lifecycle:
# 1. Setup: Start EDAMAME with auto_whitelist enabled
# 2. Traffic: Generate network traffic (daemon captures)
# 3. Teardown: Dump sessions (augments whitelist, uploads artifact)
#
# Expected lifecycle:
# - Iteration 1: Create baseline whitelist
# - Iterations 2-N: Augment with new endpoints (learning)
# - Iterations N+1 to N+3: No changes = counting stability
# - Iteration N+4+: Whitelist STABLE, enforcement begins

on:
  workflow_dispatch:
    inputs:
      iteration:
        description: 'Iteration number (for tracking)'
        required: false
        default: '1'
        type: string

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: read
  actions: write

jobs:
  test-auto-whitelist:
    name: "Iteration #${{ inputs.iteration }}"
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: "ğŸ“Š Show iteration info"
        run: |
          echo "========================================"
          echo "  AUTO-WHITELIST TEST - ITERATION ${{ inputs.iteration }}"
          echo "========================================"
          echo "  Branch: ${{ github.ref_name }}"
          echo "  Run ID: ${{ github.run_id }}"
          echo "========================================"

      # PHASE 1: Setup
      - name: "ğŸš€ Setup EDAMAME Posture"
        uses: ./
        with:
          edamame_user: ${{ vars.EDAMAME_POSTURE_USER }}
          edamame_domain: ${{ vars.EDAMAME_POSTURE_DOMAIN }}
          edamame_pin: ${{ secrets.EDAMAME_POSTURE_PIN }}
          edamame_id: ${{ github.run_id }}
          wait_for_api: true
          network_scan: true
          packet_capture: true
          auto_whitelist: true
          auto_whitelist_artifact_name: test-auto-whitelist-feature-${{ github.ref_name }}

      - name: "â³ Wait for daemon"
        run: |
          echo "Waiting 30s for daemon to stabilize..."
          sleep 30

      - name: "ğŸ” Check whitelist status"
        run: |
          cd
          echo "--- WHITELIST STATUS ---"
          
          # Check active whitelist
          WHITELIST_NAME=$($EDAMAME_POSTURE_CMD get-whitelist-name 2>/dev/null || echo "none")
          echo "Active whitelist: $WHITELIST_NAME"
          
          # Check iteration state
          if [[ -f "auto_whitelist_iteration.txt" ]]; then
            ITER=$(cat auto_whitelist_iteration.txt)
            echo "Recorded iteration: $ITER"
          fi
          
          if [[ -f "auto_whitelist_stable_count.txt" ]]; then
            STABLE=$(cat auto_whitelist_stable_count.txt)
            echo "Stability count: $STABLE/3"
          fi
          
          if [[ -f "auto_whitelist.json" ]]; then
            COUNT=$(jq '[.whitelists[]? | select(.name == "custom_whitelist") | .endpoints? // [] | length] | add // 0' auto_whitelist.json 2>/dev/null || echo "?")
            echo "Endpoints in whitelist: $COUNT"
            
            # Save for later comparison
            cp auto_whitelist.json auto_whitelist_before.json
          else
            echo "No existing whitelist (first run)"
          fi

      # PHASE 2: Generate traffic
      - name: "ğŸŒ Generate test traffic"
        run: |
          echo "--- GENERATING TRAFFIC ---"
          
          # Core endpoints (every iteration)
          echo -n "api.github.com/zen: "
          curl -s --max-time 10 https://api.github.com/zen > /dev/null && echo "âœ“" || echo "âœ—"
          
          echo -n "github.com/robots.txt: "
          curl -s --max-time 10 https://github.com/robots.txt > /dev/null && echo "âœ“" || echo "âœ—"
          
          echo -n "registry.npmjs.org/-/ping: "
          curl -s --max-time 10 https://registry.npmjs.org/-/ping > /dev/null && echo "âœ“" || echo "âœ—"
          
          # Iteration 2+: Additional endpoints to test augmentation
          if [[ "${{ inputs.iteration }}" -ge "2" ]]; then
            echo ""
            echo "Additional endpoints for iteration ${{ inputs.iteration }}:"
            echo -n "www.npmjs.com: "
            curl -s --max-time 10 https://www.npmjs.com/ > /dev/null && echo "âœ“" || echo "âœ—"
          fi
          
          echo ""
          echo "Waiting 60s for L7 resolution..."
          sleep 60

      # PHASE 3: Dump and analyze
      - name: "ğŸ“¥ Dump sessions"
        uses: ./
        with:
          dump_sessions_log: true

      - name: "ğŸ“ˆ Analyze whitelist changes"
        if: always()
        run: |
          cd
          echo ""
          echo "========================================"
          echo "  WHITELIST ANALYSIS"
          echo "========================================"
          
          if [[ ! -f "auto_whitelist.json" ]]; then
            echo "âŒ No whitelist file found!"
            exit 0
          fi
          
          NEW_COUNT=$(jq '[.whitelists[]? | select(.name == "custom_whitelist") | .endpoints? // [] | length] | add // 0' auto_whitelist.json 2>/dev/null || echo "0")
          
          # Read state files
          STABLE_COUNT="0"
          [[ -f "auto_whitelist_stable_count.txt" ]] && STABLE_COUNT=$(cat auto_whitelist_stable_count.txt)
          
          if [[ -f "auto_whitelist_before.json" ]]; then
            OLD_COUNT=$(jq '[.whitelists[]? | select(.name == "custom_whitelist") | .endpoints? // [] | length] | add // 0' auto_whitelist_before.json 2>/dev/null || echo "0")
            DELTA=$((NEW_COUNT - OLD_COUNT))
            
            echo "Before:  $OLD_COUNT endpoints"
            echo "After:   $NEW_COUNT endpoints"
            echo "Change:  $DELTA"
            echo ""
            
            if [[ $DELTA -gt 0 ]]; then
              echo "ğŸ“ Status: LEARNING - $DELTA new endpoints discovered"
            elif [[ $DELTA -lt 0 ]]; then
              echo "âš ï¸  Status: ANOMALY - Endpoint count decreased!"
            else
              echo "âœ… Status: STABLE - No new endpoints"
            fi
          else
            echo "First run - Baseline: $NEW_COUNT endpoints"
            echo ""
            echo "ğŸ“ Status: INITIAL - Baseline created"
          fi
          
          echo ""
          echo "Stability progress: $STABLE_COUNT / 3"
          
          if [[ "$STABLE_COUNT" -ge "3" ]]; then
            echo ""
            echo "ğŸ‰ WHITELIST IS STABLE - Enforcement mode active"
          fi
          
          # Show sample endpoints
          echo ""
          echo "Sample endpoints (up to 5):"
          jq -r '.whitelists[]? | select(.name == "custom_whitelist") | .endpoints[]? | "  â€¢ \(.domain // .ip // "?"):\(.port // "?") [\(.process // "any")]"' auto_whitelist.json 2>/dev/null | head -5
          
          if [[ $NEW_COUNT -gt 5 ]]; then
            echo "  ... and $((NEW_COUNT - 5)) more"
          fi

      - name: "ğŸ›‘ Stop EDAMAME Posture"
        if: always()
        uses: ./
        with:
          stop: true
        continue-on-error: true

      - name: "ğŸ“‹ Final summary"
        if: always()
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  ITERATION ${{ inputs.iteration }} COMPLETE"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

