name: Test Auto-Whitelist Feature

# This workflow tests the auto_whitelist feature using the real-world pattern:
# 1. Setup step: Start EDAMAME with auto_whitelist enabled
# 2. Do work: Generate traffic (daemon captures in background)
# 3. Teardown step: Dump sessions (augments whitelist and uploads artifact)
#
# This mimics how users would use it in production workflows

on:
  workflow_dispatch:
    inputs:
      iteration:
        description: 'Iteration number (for tracking)'
        required: false
        default: '1'
        type: string

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false  # Allow sequential runs

permissions:
  contents: read
  actions: write

jobs:
  test-auto-whitelist:
    name: Auto-Whitelist Test Iteration ${{ inputs.iteration }}
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ============================================================
      # STEP 1: Setup EDAMAME Posture (like release_macos_standalone.yml:46-55)
      # ============================================================
      - name: Setup EDAMAME Posture with Auto-Whitelist
        uses: ./
        with:
          disconnected_mode: true
          network_scan: true
          packet_capture: true
          auto_whitelist: true
          auto_whitelist_artifact_name: test-auto-whitelist-feature-${{ github.ref_name }}
          auto_whitelist_stability_threshold: "0"
          auto_whitelist_stability_consecutive_runs: "3"
          auto_whitelist_max_iterations: "10"
          include_local_traffic: false
          display_logs: false

      # ============================================================
      # STEP 2: Do work (build, test, etc.) - daemon captures traffic
      # ============================================================
      - name: Wait for daemon readiness
        run: |
          echo "Waiting for EDAMAME Posture daemon to be ready..."
          sleep 30

      - name: Verify whitelist is active (for iterations > 1)
        if: inputs.iteration != '1'
        run: |
          echo "Verifying whitelist is active for iteration ${{ inputs.iteration }}..."
          cd
          WHITELIST_NAME=$($EDAMAME_POSTURE_CMD get-whitelist-name 2>/dev/null || echo "")
          if [[ -z "$WHITELIST_NAME" ]]; then
            echo "⚠️ Warning: No whitelist is currently active"
          else
            echo "✅ Active whitelist: $WHITELIST_NAME"
          fi

      - name: Generate test traffic (simulate build/test work)
        run: |
          echo "Generating test traffic for iteration ${{ inputs.iteration }}..."
          
          # Generate consistent traffic patterns
          curl -s --max-time 10 https://api.github.com/zen > /dev/null || true
          curl -s --max-time 10 https://github.com/robots.txt > /dev/null || true
          curl -s --max-time 10 https://registry.npmjs.org/-/ping > /dev/null || true
          
          # Add variation based on iteration to test augmentation
          if [[ "${{ inputs.iteration }}" == "2" ]]; then
            echo "Iteration 2: Adding new endpoints..."
            curl -s --max-time 10 https://www.npmjs.com/ > /dev/null || true
            curl -s --max-time 10 https://cdn.jsdelivr.net/npm/ > /dev/null || true
          fi
          
          echo "Waiting for traffic capture..."
          sleep 30

      # ============================================================
      # STEP 3: Teardown - Dump sessions (like release_macos_standalone.yml:253-256)
      # This step augments the whitelist and uploads the artifact
      # ============================================================
      - name: Dump EDAMAME Posture sessions and augment whitelist
        uses: ./
        with:
          auto_whitelist: true
          auto_whitelist_artifact_name: test-auto-whitelist-feature-${{ github.ref_name }}
          auto_whitelist_stability_threshold: "0"
          auto_whitelist_stability_consecutive_runs: "3"
          auto_whitelist_max_iterations: "10"
          dump_sessions_log: true
          display_logs: true

      - name: Stop EDAMAME Posture
        uses: ./
        with:
          stop: true
        continue-on-error: true

