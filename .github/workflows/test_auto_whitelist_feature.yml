name: Test Auto-Whitelist Feature

# This workflow tests the auto_whitelist feature using the real-world pattern:
# 1. Setup step: Start EDAMAME with auto_whitelist enabled (connected mode)
# 2. Do work: Generate traffic (daemon captures in background)
# 3. Teardown step: Dump sessions (augments whitelist and uploads artifact)
#
# Uses connected mode to bypass IP allow list for artifact download/upload
# This mimics how users would use it in production workflows

on:
  workflow_dispatch:
    inputs:
      iteration:
        description: 'Iteration number (for tracking)'
        required: false
        default: '1'
        type: string

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false  # Allow sequential runs

permissions:
  contents: read
  actions: write

jobs:
  test-auto-whitelist:
    name: Auto-Whitelist Test Iteration ${{ inputs.iteration }}
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ============================================================
      # STEP 1: Setup EDAMAME Posture
      # Downloads artifact, applies whitelist to daemon, starts capture
      # MUST succeed in applying whitelist (except on true first run)
      # Uses CONNECTED mode to bypass IP allow list for artifact download
      # ============================================================
      - name: Setup EDAMAME Posture with Auto-Whitelist
        uses: ./
        with:
          edamame_user: ${{ vars.EDAMAME_POSTURE_USER }}
          edamame_domain: ${{ vars.EDAMAME_POSTURE_DOMAIN }}
          edamame_pin: ${{ secrets.EDAMAME_POSTURE_PIN }}
          edamame_id: ${{ github.run_id }}
          # We are using the API to download the artifact, so we need to wait for it to be ready.
          wait_for_api: true
          network_scan: true
          packet_capture: true
          auto_whitelist: true
          auto_whitelist_artifact_name: test-auto-whitelist-feature-${{ github.ref_name }}

      # ============================================================
      # STEP 2: Do work (build, test, etc.) - daemon captures traffic
      # ============================================================
      - name: Wait for daemon readiness
        run: |
          echo "Waiting for EDAMAME Posture daemon to be ready..."
          sleep 30

      - name: Verify whitelist is active (for iterations > 1)
        if: inputs.iteration != '1'
        run: |
          echo "Verifying whitelist is active for iteration ${{ inputs.iteration }}..."
          cd
          WHITELIST_NAME=$($EDAMAME_POSTURE_CMD get-whitelist-name 2>/dev/null || echo "")
          if [[ -z "$WHITELIST_NAME" ]]; then
            echo "⚠️ Warning: No whitelist is currently active"
          else
            echo "✅ Active whitelist: $WHITELIST_NAME"
          fi

      - name: Generate test traffic (simulate build/test work)
        run: |
          echo "Generating test traffic for iteration ${{ inputs.iteration }}..."
          
          # Generate consistent traffic patterns
          curl -s --max-time 10 https://api.github.com/zen > /dev/null || true
          curl -s --max-time 10 https://github.com/robots.txt > /dev/null || true
          curl -s --max-time 10 https://registry.npmjs.org/-/ping > /dev/null || true
          
          # Add variation based on iteration to test augmentation
          if [[ "${{ inputs.iteration }}" == "2" ]]; then
            echo "Iteration 2: Adding new endpoints..."
            curl -s --max-time 10 https://www.npmjs.com/ > /dev/null || true
            curl -s --max-time 10 https://cdn.jsdelivr.net/npm/ > /dev/null || true
          fi
          
          echo "Waiting for traffic capture..."
          sleep 30

      # ============================================================
      # STEP 3: Teardown - Dump sessions (like release_macos_standalone.yml:253-256)
      # Automatically augments whitelist and uploads artifact
      # 
      # EXPECTED BEHAVIOR:
      # - Iterations 1-N (learning/evolving): Whitelist exceptions are EXPECTED
      #   * New endpoints are being discovered and added
      #   * Action automatically allows exceptions (does NOT fail)
      #   * Endpoint count should increase or stay stable (not decrease)
      # 
      # - Iterations N+1 to N+3 (confirming stability): 
      #   * No new endpoints discovered (0% change)
      #   * Action still allows exceptions (still NOT failing)
      #   * Counting consecutive stable runs (1/3, 2/3, 3/3)
      # 
      # - Iteration N+4+ (stable/enforcing): Whitelist is STABLE
      #   * Action automatically ENFORCES whitelist (WILL fail on exceptions)
      #   * Any new endpoint = supply chain attack detected
      #   * Workflow fails to protect against unauthorized connections
      # 
      # KNOWN ISSUE (Core Implementation):
      # - Endpoint counts may fluctuate instead of monotonically increasing
      # - This indicates augment-custom-whitelists is creating fresh whitelists
      #   instead of merging exceptions with existing whitelist
      # - This is a CORE bug, not an action bug
      # - The action correctly downloads, applies, and calls augment-custom-whitelists
      # - The daemon should be merging but appears to be replacing instead
      # 
      # The action automatically detects auto-whitelist mode from first invocation
      # and uses saved configuration - NO parameters need to be repeated here!
      # ============================================================
      - name: Save old whitelist for comparison
        run: |
          cd
          if [[ -f "auto_whitelist.json" ]]; then
            echo "Saving old whitelist for comparison..."
            cp auto_whitelist.json auto_whitelist_old.json
            
            # Count endpoints in old whitelist
            if command -v jq &> /dev/null; then
              OLD_COUNT=$(jq '[.whitelists[]? | select(.name == "custom_whitelist") | .endpoints? // [] | length] | add // 0' auto_whitelist_old.json 2>/dev/null || echo "0")
              echo "Old whitelist has $OLD_COUNT endpoints"
            fi
          else
            echo "No existing whitelist (first iteration)"
          fi

      - name: Dump EDAMAME Posture sessions
        uses: ./
        with:
          dump_sessions_log: true
          display_logs: true

      - name: Show augmented whitelist changes
        if: always()
        run: |
          cd
          echo "=========================================="
          echo "Auto-Whitelist Changes - Iteration ${{ inputs.iteration }}"
          echo "=========================================="
          
          if [[ -f "auto_whitelist.json" ]]; then
            # Show iteration info
            if [[ -f "auto_whitelist_iteration.txt" ]]; then
              ITERATION=$(cat auto_whitelist_iteration.txt)
              echo "Iteration: $ITERATION"
            fi
            
            if command -v jq &> /dev/null; then
              NEW_COUNT=$(jq '[.whitelists[]? | select(.name == "custom_whitelist") | .endpoints? // [] | length] | add // 0' auto_whitelist.json 2>/dev/null || echo "0")
              echo "New whitelist has $NEW_COUNT endpoints"
              
              # Compare with old if it exists
              if [[ -f "auto_whitelist_old.json" ]]; then
                OLD_COUNT=$(jq '[.whitelists[]? | select(.name == "custom_whitelist") | .endpoints? // [] | length] | add // 0' auto_whitelist_old.json 2>/dev/null || echo "0")
                DELTA=$((NEW_COUNT - OLD_COUNT))
                echo "Change: $DELTA endpoints (${OLD_COUNT} → ${NEW_COUNT})"
                
                # Show what endpoints were added
                if [[ $DELTA -gt 0 ]]; then
                  echo ""
                  echo "New endpoints added in this iteration:"
                  # Extract new endpoints (those in new but not in old)
                  jq -r --slurpfile old auto_whitelist_old.json '
                    .whitelists[]? | select(.name == "custom_whitelist") | .endpoints[]? as $new_ep |
                    ($old[0].whitelists[]? | select(.name == "custom_whitelist") | .endpoints[]?) as $old_ep |
                    select($new_ep == $old_ep | not) |
                    $new_ep | "  - \(.host // .ip):\(.port // "N/A") (\(.protocol // "unknown"))"
                  ' auto_whitelist.json 2>/dev/null | sort -u | head -20
                  
                  if [[ $DELTA -gt 20 ]]; then
                    echo "  ... and $((DELTA - 20)) more endpoints"
                  fi
                elif [[ $DELTA -lt 0 ]]; then
                  echo ""
                  echo "⚠️ WARNING: Endpoint count DECREASED by $((0 - DELTA))"
                  echo "This may indicate augmentation is replacing instead of merging"
                else
                  echo ""
                  echo "✅ No new endpoints (whitelist stable)"
                fi
              else
                echo "First iteration: created baseline with $NEW_COUNT endpoints"
                
                # Show first few endpoints
                if [[ $NEW_COUNT -gt 0 ]]; then
                  echo ""
                  echo "Initial endpoints (first 10):"
                  jq -r '.whitelists[]? | select(.name == "custom_whitelist") | .endpoints[]? | "  - \(.host // .ip):\(.port // "N/A") (\(.protocol // "unknown"))"' auto_whitelist.json 2>/dev/null | head -10
                  if [[ $NEW_COUNT -gt 10 ]]; then
                    echo "  ... and $((NEW_COUNT - 10)) more endpoints"
                  fi
                fi
              fi
            else
              echo "jq not available, cannot show detailed changes"
            fi
          else
            echo "No whitelist artifact found after dump"
          fi
          
          echo "=========================================="
        shell: bash

      - name: Stop EDAMAME Posture
        uses: ./
        with:
          stop: true
        continue-on-error: true

