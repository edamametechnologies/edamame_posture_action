name: Test Auto-Whitelist Runner

# Orchestrates multiple runs of test_auto_whitelist_feature.yml
# to validate the complete auto-whitelist lifecycle:
#   1. Clean slate → baseline creation
#   2. Learning → endpoint discovery
#   3. Stability → 3 consecutive unchanged runs
#   4. Enforcement → reject new endpoints

on:
  schedule:
    - cron: '0 2 * * *'  # Daily at 02:00 UTC
  workflow_dispatch:
  push:
    branches: ['dev', 'main']

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  actions: write

jobs:
  test-auto-whitelist-runner:
    name: Auto-Whitelist Lifecycle Test
    runs-on: ubuntu-latest
    timeout-minutes: 180
    
    steps:
      - name: "Test info"
        run: |
          echo "========================================"
          echo "  AUTO-WHITELIST LIFECYCLE TEST"
          echo "========================================"
          echo "  Repository: ${{ github.repository }}"
          echo "  Branch:     ${{ github.ref_name }}"
          echo "  Trigger:    ${{ github.event_name }}"
          echo "========================================"
          echo ""
          echo "This test will:"
          echo "  1. Delete existing artifacts (clean slate)"
          echo "  2. Trigger multiple workflow iterations"
          echo "  3. Track endpoint discovery and stability"
          echo "  4. Verify lifecycle reaches enforcement state"

      - name: "Setup EDAMAME Posture"
        uses: edamametechnologies/edamame_posture_action@v0
        with:
          edamame_user: ${{ vars.EDAMAME_POSTURE_USER }}
          edamame_domain: ${{ vars.EDAMAME_POSTURE_DOMAIN }}
          edamame_pin: ${{ secrets.EDAMAME_POSTURE_PIN }}
          edamame_id: ${{ github.run_id }}
          auto_remediate: false
          network_scan: false
          checkout: true
          wait_for_api: true

      - name: "Verify gh CLI"
        run: |
          if command -v gh &> /dev/null; then
            echo "✓ gh CLI available: $(gh --version | head -1)"
          else
            echo "Installing gh CLI..."
            type -p wget >/dev/null || sudo apt-get install -y wget
            sudo mkdir -p -m 755 /etc/apt/keyrings
            wget -qO- https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo tee /etc/apt/keyrings/githubcli-archive-keyring.gpg > /dev/null
            sudo chmod go+r /etc/apt/keyrings/githubcli-archive-keyring.gpg
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
            sudo apt-get install -y gh
          fi

      - name: "Prepare test script"
        run: chmod +x ./tests/test_auto_whitelist_feature.sh

      - name: "Run lifecycle test"
        id: test
        env:
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: ./tests/test_auto_whitelist_feature.sh

      - name: "Upload test artifacts"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: auto-whitelist-test-results-${{ github.run_id }}
          path: /tmp/auto_whitelist_test_*
          retention-days: 7
          if-no-files-found: ignore


