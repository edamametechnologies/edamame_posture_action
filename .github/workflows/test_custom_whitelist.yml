name: Test Custom Whitelist Lifecycle

# This workflow tests the complete manual custom whitelist lifecycle including:
# 1. Learning phase: Generate baseline whitelist from legitimate traffic
# 2. Augmentation phase: Add new endpoints to existing whitelist
# 3. Enforcement phase (pass): Verify authorized traffic is allowed
# 4. Enforcement phase (fail): Detect violations when unauthorized traffic occurs
# 5. Artifact persistence: Upload/download whitelist across workflow runs
#
# Note: This tests manual whitelist operations (create_custom_whitelists, augment_custom_whitelists).
# For testing the automated auto_whitelist feature, see test.yml which includes auto_whitelist: true tests.
#
# Important notes:
# - Uses include_local_traffic: false to avoid capturing localhost/runner system traffic
# - Uses 30s waits to let background GitHub runner traffic settle before our test traffic
# - Uses specific, stable URLs (e.g., /zen, /robots.txt) for consistent endpoint capture

on:
  workflow_dispatch:
    inputs:
      cleanup_artifacts:
        description: 'Delete existing whitelist artifacts before running'
        required: false
        default: false
        type: boolean
  push:
    branches:
      - 'dev'
      - 'main'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  actions: write

jobs:
  # Phase 1: Learning - Generate baseline whitelist
  learning-phase:
    name: Learning Phase - Generate Baseline Whitelist
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Clean up existing artifacts (optional)
        if: github.event_name == 'workflow_dispatch' && inputs.cleanup_artifacts == true
        env:
          GH_TOKEN: ${{ github.token }}
        continue-on-error: true
        run: |
          echo "Cleaning up existing auto-whitelist artifacts..."
          ARTIFACT_NAME="test-auto-whitelist-${{ github.run_id }}"
          ARTIFACT_IDS=$(gh api repos/${{ github.repository }}/actions/artifacts --paginate --jq ".artifacts[] | select(.name | startswith(\"test-auto-whitelist-\")) | .id" 2>/dev/null || true)
          if [[ -n "$ARTIFACT_IDS" ]]; then
            echo "$ARTIFACT_IDS" | while read -r ARTIFACT_ID; do
              [[ -n "$ARTIFACT_ID" ]] || continue
              echo "Deleting artifact id $ARTIFACT_ID"
              gh api repos/${{ github.repository }}/actions/artifacts/$ARTIFACT_ID -X DELETE 2>/dev/null || echo "Failed to delete (may already be expired)"
            done
          else
            echo "No existing artifacts found"
          fi

      - name: Start EDAMAME Posture in disconnected mode
        id: start-edamame
        uses: ./
        with:
          disconnected_mode: true
          network_scan: true
          packet_capture: true
          whitelist: github_ubuntu
          include_local_traffic: false
          display_logs: false

      - name: Wait for capture readiness and let background traffic settle
        run: |
          echo "Waiting for EDAMAME Posture to be ready and background traffic to settle..."
          sleep 30

      - name: Generate legitimate baseline traffic
        run: |
          echo "Generating baseline traffic for whitelist learning..."
          
          # Simulate typical CI/CD traffic - use specific, predictable endpoints
          curl -s --max-time 10 https://api.github.com/zen > /dev/null || true
          curl -s --max-time 10 https://github.com/robots.txt > /dev/null || true
          curl -s --max-time 10 https://registry.npmjs.org/-/ping > /dev/null || true
          
          # Wait for traffic to be captured
          echo "Waiting for traffic capture..."
          sleep 30

      - name: Create custom whitelist from captured traffic
        id: create-whitelist
        uses: ./
        with:
          create_custom_whitelists: true
          custom_whitelists_path: ${{ github.workspace }}/baseline_whitelist.json
          display_logs: true

      - name: Stop EDAMAME Posture
        uses: ./
        with:
          stop: true
        continue-on-error: true

      - name: Validate baseline whitelist is not empty
        run: |
          echo "Validating baseline whitelist..."
          
          if [[ ! -f "${{ github.workspace }}/baseline_whitelist.json" ]]; then
            echo "‚ùå ERROR: baseline_whitelist.json was not created" >&2
            exit 1
          fi
          
          if [[ ! -s "${{ github.workspace }}/baseline_whitelist.json" ]]; then
            echo "‚ùå ERROR: baseline_whitelist.json is empty" >&2
            exit 1
          fi
          
          # Check if it's valid JSON
          if ! jq empty "${{ github.workspace }}/baseline_whitelist.json" 2>/dev/null; then
            echo "‚ùå ERROR: baseline_whitelist.json is not valid JSON" >&2
            cat "${{ github.workspace }}/baseline_whitelist.json"
            exit 1
          fi
          
          # Count endpoints
          ENDPOINT_COUNT=$(jq '[.whitelists[].endpoints | length] | add // 0' "${{ github.workspace }}/baseline_whitelist.json" 2>/dev/null || echo '0')
          echo "‚úÖ Baseline whitelist contains $ENDPOINT_COUNT endpoints"
          
          if [[ "$ENDPOINT_COUNT" -eq 0 ]]; then
            echo "‚ùå ERROR: Whitelist contains no endpoints" >&2
            cat "${{ github.workspace }}/baseline_whitelist.json"
            exit 1
          fi
          
          # Display whitelist content for debugging
          echo "Baseline whitelist content:"
          jq '.' "${{ github.workspace }}/baseline_whitelist.json"

      - name: Upload baseline whitelist as artifact
        uses: actions/upload-artifact@v4
        with:
          name: test-auto-whitelist-${{ github.run_id }}-baseline
          path: ${{ github.workspace }}/baseline_whitelist.json
          retention-days: 1

  # Phase 2: Augmentation - Add new endpoints to existing whitelist
  augmentation-phase:
    name: Augmentation Phase - Add New Endpoints
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: learning-phase
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download baseline whitelist artifact
        uses: actions/download-artifact@v4
        with:
          name: test-auto-whitelist-${{ github.run_id }}-baseline
          path: ${{ github.workspace }}

      - name: Verify downloaded whitelist
        run: |
          echo "Verifying downloaded baseline whitelist..."
          
          if [[ ! -f "${{ github.workspace }}/baseline_whitelist.json" ]]; then
            echo "‚ùå ERROR: Failed to download baseline_whitelist.json" >&2
            exit 1
          fi
          
          BASELINE_COUNT=$(jq '[.whitelists[].endpoints | length] | add // 0' "${{ github.workspace }}/baseline_whitelist.json")
          echo "‚úÖ Downloaded baseline whitelist with $BASELINE_COUNT endpoints"

      - name: Start EDAMAME Posture
        uses: ./
        with:
          disconnected_mode: true
          network_scan: true
          packet_capture: true
          whitelist: github_ubuntu
          include_local_traffic: false
          display_logs: false

      - name: Wait for capture readiness and let background traffic settle
        run: |
          echo "Waiting for EDAMAME Posture to be ready and background traffic to settle..."
          sleep 30

      - name: Load baseline whitelist before augmentation
        uses: ./
        with:
          custom_whitelists_path: ${{ github.workspace }}/baseline_whitelist.json
          set_custom_whitelists: true
          display_logs: false

      - name: Generate additional traffic (new endpoints)
        run: |
          echo "Generating traffic with new endpoints..."
          
          # Replay baseline traffic
          curl -s --max-time 10 https://api.github.com/zen > /dev/null || true
          curl -s --max-time 10 https://github.com/robots.txt > /dev/null || true
          curl -s --max-time 10 https://registry.npmjs.org/-/ping > /dev/null || true
          
          # Add new endpoints that weren't in baseline
          curl -s --max-time 10 https://www.npmjs.com/ > /dev/null || true
          curl -s --max-time 10 https://cdn.jsdelivr.net/npm/ > /dev/null || true
          
          echo "Waiting for traffic capture..."
          sleep 30

      - name: Iterative augmentation until stable
        run: |
          cd
          
          # Set EDAMAME_POSTURE_CMD if not already set
          if [[ -z "$EDAMAME_POSTURE_CMD" ]]; then
            if command -v edamame_posture >/dev/null 2>&1; then
              EDAMAME_POSTURE_CMD="sudo edamame_posture"
            else
              EDAMAME_POSTURE_CMD="sudo ./edamame_posture"
            fi
          fi
          
          MAX_ITERATIONS=5
          STABILITY_THRESHOLD=0
          ITERATION=1
          STABLE=false
          
          # Save initial whitelist for comparison
          cp "${{ github.workspace }}/baseline_whitelist.json" "${{ github.workspace }}/baseline_whitelist_prev.json"
          
          while [[ $ITERATION -le $MAX_ITERATIONS && "$STABLE" == "false" ]]; do
            echo "=== Augmentation Iteration $ITERATION ==="
            
            # Force session update before augmentation
            echo "Forcing session update..."
            $EDAMAME_POSTURE_CMD get-sessions > /dev/null 2>&1 || true
            sleep 2
            
            # Augment whitelist
            echo "Augmenting whitelist..."
            $EDAMAME_POSTURE_CMD augment-custom-whitelists > "${{ github.workspace }}/baseline_whitelist_new.json"
            
            # Check if augmentation succeeded
            if [[ ! -f "${{ github.workspace }}/baseline_whitelist_new.json" ]] || [[ ! -s "${{ github.workspace }}/baseline_whitelist_new.json" ]]; then
              echo "‚ùå ERROR: Augmentation failed or returned empty output"
              exit 1
            fi
            
            # Compare with previous version
            DIFF_PERCENT=$($EDAMAME_POSTURE_CMD compare-custom-whitelists-from-files "${{ github.workspace }}/baseline_whitelist_prev.json" "${{ github.workspace }}/baseline_whitelist_new.json" 2>/dev/null | sed 's/%//' || echo "100")
            echo "Whitelist difference: ${DIFF_PERCENT}%"
            
            # Check if stable (difference <= threshold)
            if command -v bc &> /dev/null; then
              IS_STABLE=$(echo "$DIFF_PERCENT <= $STABILITY_THRESHOLD" | bc -l)
            else
              DIFF_INT=${DIFF_PERCENT%.*}
              [[ $DIFF_INT -le $STABILITY_THRESHOLD ]] && IS_STABLE=1 || IS_STABLE=0
            fi
            
            if [[ "$IS_STABLE" == "1" ]]; then
              echo "‚úÖ Whitelist is STABLE (diff: ${DIFF_PERCENT}% <= threshold: ${STABILITY_THRESHOLD}%)"
              STABLE=true
              mv "${{ github.workspace }}/baseline_whitelist_new.json" "${{ github.workspace }}/baseline_whitelist.json"
            else
              echo "üîÑ Whitelist is EVOLVING (diff: ${DIFF_PERCENT}% > threshold: ${STABILITY_THRESHOLD}%)"
              mv "${{ github.workspace }}/baseline_whitelist_new.json" "${{ github.workspace }}/baseline_whitelist.json"
              cp "${{ github.workspace }}/baseline_whitelist.json" "${{ github.workspace }}/baseline_whitelist_prev.json"
              
              # Reload the updated whitelist into the running process
              echo "Reloading updated whitelist..."
              $EDAMAME_POSTURE_CMD set-custom-whitelists-from-file "${{ github.workspace }}/baseline_whitelist.json"
              
              # Wait for more traffic to be captured
              echo "Waiting for additional traffic capture..."
              sleep 20
            fi
            
            ITERATION=$((ITERATION + 1))
          done
          
          if [[ "$STABLE" == "false" ]]; then
            echo "‚ö†Ô∏è Warning: Maximum iterations ($MAX_ITERATIONS) reached, whitelist may not be fully stable"
          fi
          
          # Final validation
          if [[ ! -f "${{ github.workspace }}/baseline_whitelist.json" ]]; then
            echo "‚ùå ERROR: Augmented whitelist not found" >&2
            exit 1
          fi
          
          AUGMENTED_COUNT=$(jq '[.whitelists[].endpoints | length] | add // 0' "${{ github.workspace }}/baseline_whitelist.json")
          echo "‚úÖ Final augmented whitelist contains $AUGMENTED_COUNT endpoints"
          
          # Display final whitelist
          echo "Final augmented whitelist content:"
          jq '.' "${{ github.workspace }}/baseline_whitelist.json"
        shell: bash

      - name: Stop EDAMAME Posture
        uses: ./
        with:
          stop: true
        continue-on-error: true

      - name: Rename for upload
        run: |
          cp "${{ github.workspace }}/baseline_whitelist.json" "${{ github.workspace }}/augmented_whitelist.json"

      - name: Upload augmented whitelist as artifact
        uses: actions/upload-artifact@v4
        with:
          name: test-auto-whitelist-${{ github.run_id }}-augmented
          path: ${{ github.workspace }}/augmented_whitelist.json
          retention-days: 1

  # Phase 3: Enforcement - Verify whitelist detects violations
  enforcement-phase-pass:
    name: Enforcement Phase - Authorized Traffic (Pass)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: augmentation-phase
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download augmented whitelist artifact
        uses: actions/download-artifact@v4
        with:
          name: test-auto-whitelist-${{ github.run_id }}-augmented
          path: ${{ github.workspace }}

      - name: Verify downloaded whitelist
        run: |
          echo "Verifying downloaded augmented whitelist..."
          
          if [[ ! -f "${{ github.workspace }}/augmented_whitelist.json" ]]; then
            echo "‚ùå ERROR: Failed to download augmented_whitelist.json" >&2
            exit 1
          fi
          
          COUNT=$(jq '[.whitelists[].endpoints | length] | add // 0' "${{ github.workspace }}/augmented_whitelist.json")
          echo "‚úÖ Downloaded augmented whitelist with $COUNT endpoints"

      - name: Start EDAMAME Posture with enforcement
        uses: ./
        with:
          disconnected_mode: true
          network_scan: true
          packet_capture: true
          custom_whitelists_path: ${{ github.workspace }}/augmented_whitelist.json
          set_custom_whitelists: true
          include_local_traffic: false
          display_logs: false

      - name: Wait for capture readiness and let background traffic settle
        run: |
          echo "Waiting for EDAMAME Posture to be ready and background traffic to settle..."
          sleep 30

      - name: Generate only authorized traffic
        run: |
          echo "Generating only whitelisted traffic (should pass)..."
          
          # Only use endpoints that are in the augmented whitelist - exact same URLs as learning/augmentation
          curl -s --max-time 10 https://api.github.com/zen > /dev/null || true
          curl -s --max-time 10 https://github.com/robots.txt > /dev/null || true
          curl -s --max-time 10 https://registry.npmjs.org/-/ping > /dev/null || true
          curl -s --max-time 10 https://www.npmjs.com/ > /dev/null || true
          curl -s --max-time 10 https://cdn.jsdelivr.net/npm/ > /dev/null || true
          
          echo "Waiting for traffic analysis..."
          sleep 30

      - name: Check for whitelist violations (should pass)
        id: check-violations-pass
        uses: ./
        with:
          dump_sessions_log: true
          exit_on_whitelist_exceptions: true
          display_logs: true

      - name: Stop EDAMAME Posture
        uses: ./
        with:
          stop: true
        continue-on-error: true

      - name: Verify enforcement passed
        run: |
          echo "‚úÖ SUCCESS: Authorized traffic passed whitelist enforcement"

  # Phase 4: Enforcement - Detect violations
  enforcement-phase-fail:
    name: Enforcement Phase - Unauthorized Traffic (Fail Expected)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: augmentation-phase
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download augmented whitelist artifact
        uses: actions/download-artifact@v4
        with:
          name: test-auto-whitelist-${{ github.run_id }}-augmented
          path: ${{ github.workspace }}

      - name: Start EDAMAME Posture with enforcement
        uses: ./
        with:
          disconnected_mode: true
          network_scan: true
          packet_capture: true
          custom_whitelists_path: ${{ github.workspace }}/augmented_whitelist.json
          set_custom_whitelists: true
          include_local_traffic: false
          display_logs: false

      - name: Wait for capture readiness and let background traffic settle
        run: |
          echo "Waiting for EDAMAME Posture to be ready and background traffic to settle..."
          sleep 30

      - name: Generate unauthorized traffic
        run: |
          echo "Generating whitelisted + unauthorized traffic (should fail)..."
          
          # Some authorized traffic (same as learning/augmentation)
          curl -s --max-time 10 https://api.github.com/zen > /dev/null || true
          curl -s --max-time 10 https://github.com/robots.txt > /dev/null || true
          
          # UNAUTHORIZED traffic - should trigger violation
          curl -s --max-time 10 https://example.com > /dev/null || true
          curl -s --max-time 10 https://httpbin.org/get > /dev/null || true
          
          echo "Waiting for traffic analysis..."
          sleep 30

      - name: Check for whitelist violations (should fail)
        id: check-violations-fail
        uses: ./
        with:
          dump_sessions_log: true
          exit_on_whitelist_exceptions: true
          display_logs: true
        continue-on-error: true

      - name: Stop EDAMAME Posture
        uses: ./
        with:
          stop: true
        continue-on-error: true

      - name: Verify enforcement detected violations
        env:
          CHECK_OUTCOME: ${{ steps.check-violations-fail.outcome }}
        run: |
          echo "Verification outcome: $CHECK_OUTCOME"
          
          if [[ "$CHECK_OUTCOME" == "failure" ]]; then
            echo "‚úÖ SUCCESS: Whitelist enforcement correctly detected unauthorized traffic"
            exit 0
          else
            echo "‚ùå FAILURE: Whitelist enforcement failed to detect unauthorized traffic"
            exit 1
          fi

  # Final validation job
  validate-complete-lifecycle:
    name: Validate Complete Lifecycle
    runs-on: ubuntu-latest
    needs: [learning-phase, augmentation-phase, enforcement-phase-pass, enforcement-phase-fail]
    if: always()
    steps:
      - name: Check all phases completed successfully
        env:
          LEARNING_RESULT: ${{ needs.learning-phase.result }}
          AUGMENTATION_RESULT: ${{ needs.augmentation-phase.result }}
          ENFORCEMENT_PASS_RESULT: ${{ needs.enforcement-phase-pass.result }}
          ENFORCEMENT_FAIL_RESULT: ${{ needs.enforcement-phase-fail.result }}
        run: |
          echo "=== Custom Whitelist Lifecycle Test Results ==="
          echo "Learning Phase:            $LEARNING_RESULT"
          echo "Augmentation Phase:        $AUGMENTATION_RESULT"
          echo "Enforcement (Pass):        $ENFORCEMENT_PASS_RESULT"
          echo "Enforcement (Fail):        $ENFORCEMENT_FAIL_RESULT"
          echo "=============================================="
          
          FAILED=false
          
          if [[ "$LEARNING_RESULT" != "success" ]]; then
            echo "‚ùå Learning phase failed"
            FAILED=true
          fi
          
          if [[ "$AUGMENTATION_RESULT" != "success" ]]; then
            echo "‚ùå Augmentation phase failed"
            FAILED=true
          fi
          
          if [[ "$ENFORCEMENT_PASS_RESULT" != "success" ]]; then
            echo "‚ùå Enforcement phase (authorized traffic) failed"
            FAILED=true
          fi
          
          if [[ "$ENFORCEMENT_FAIL_RESULT" != "success" ]]; then
            echo "‚ùå Enforcement phase (unauthorized traffic) failed"
            FAILED=true
          fi
          
          if [[ "$FAILED" == "true" ]]; then
            echo ""
            echo "‚ùå OVERALL: Custom whitelist lifecycle test FAILED"
            exit 1
          else
            echo ""
            echo "‚úÖ OVERALL: Custom whitelist lifecycle test PASSED"
            echo "All phases completed successfully:"
            echo "  ‚úÖ Whitelist creation from traffic"
            echo "  ‚úÖ Artifact upload/download"
            echo "  ‚úÖ Whitelist augmentation"
            echo "  ‚úÖ Enforcement with authorized traffic"
            echo "  ‚úÖ Violation detection with unauthorized traffic"
          fi

      - name: Send Slack notification on failure
        if: failure()
        uses: slackapi/slack-github-action@v1.26.0
        with:
          channel-id: 'C072J0U9TH7'
          slack-message: |
            ‚ùå Custom Whitelist Lifecycle Test Failed
            Repository: ${{ github.repository }}
            Branch: ${{ github.ref }}
            Run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            Phase Results:
            - Learning: ${{ needs.learning-phase.result }}
            - Augmentation: ${{ needs.augmentation-phase.result }}
            - Enforcement (Pass): ${{ needs.enforcement-phase-pass.result }}
            - Enforcement (Fail): ${{ needs.enforcement-phase-fail.result }}
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
        continue-on-error: true
